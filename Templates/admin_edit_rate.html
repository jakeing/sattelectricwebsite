
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Worker Roles & Rates</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2>Worker Roles & Rates Management</h2>
                <a href="{{ url_for('index') }}" class="btn btn-secondary mb-3">‚Üê Back to Dashboard</a>
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-info alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Add New Role Form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Add New Worker Role</h5>
                    </div>
                    <div class="card-body">
                        <form id="addRoleForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="roleName" class="form-label">Role Name</label>
                                        <input type="text" class="form-control" id="roleName" name="name" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="hourlyRate" class="form-label">Hourly Rate ($)</label>
                                        <input type="number" class="form-control" id="hourlyRate" name="hourly_rate" step="0.01" min="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="submit" class="btn btn-primary d-block">Add Role</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Existing Roles Table -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Current Worker Roles</h5>
                    </div>
                    <div class="card-body">
                        {% if roles %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Role Name</th>
                                            <th>Hourly Rate</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rolesTableBody">
                                        {% for role in roles %}
                                            <tr id="role-{{ role.id }}">
                                                <td>{{ role.id }}</td>
                                                <td>
                                                    <!-- Display Mode -->
                                                    <span id="role-name-display-{{ role.id }}">{{ role.name }}</span>
                                                    <!-- Edit Mode -->
                                                    <input type="text" class="form-control d-none" id="role-name-edit-{{ role.id }}" value="{{ role.name }}">
                                                </td>
                                                <td>
                                                    <!-- Display Mode -->
                                                    <span id="role-rate-display-{{ role.id }}">${{ "%.2f"|format(role.hourly_rate) }}</span>
                                                    <!-- Edit Mode -->
                                                    <input type="number" class="form-control d-none" id="role-rate-edit-{{ role.id }}" value="{{ role.hourly_rate }}" step="0.01" min="0.01">
                                                </td>
                                                <td>
                                                    <!-- Display Mode Buttons -->
                                                    <div id="display-buttons-{{ role.id }}">
                                                        <button class="btn btn-warning btn-sm me-1" onclick="startEdit({{ role.id }})">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                        <a href="{{ url_for('assign_users_to_role', role_id=role.id) }}" class="btn btn-info btn-sm me-1">
                                                            <i class="fas fa-users"></i> Assign Users
                                                        </a>
                                                        <button class="btn btn-danger btn-sm" onclick="removeRole({{ role.id }}, '{{ role.name }}')">
                                                            Remove
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- Edit Mode Buttons -->
                                                    <div id="edit-buttons-{{ role.id }}" class="d-none">
                                                        <button class="btn btn-success btn-sm me-2" onclick="saveEdit({{ role.id }})">
                                                            <i class="fas fa-check"></i> Save
                                                        </button>
                                                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit({{ role.id }})">
                                                            <i class="fas fa-times"></i> Cancel
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                No worker roles found. Add some roles using the form above.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Roles Assignment Overview Section -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-users"></i> Roles Assignment Overview</h3>
                    </div>
                    <div class="card-body">
                        {% if has_worker_role_field %}
                            <!-- Assigned Users by Role -->
                            {% if role_assignments %}
                                {% for role_id, assignment_data in role_assignments.items() %}
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="text-primary mb-0">
                                                <i class="fas fa-briefcase"></i> {{ assignment_data.role.name }} 
                                                <small class="text-muted">({{ assignment_data.user_count }} users)</small>
                                                <span class="badge bg-success ms-2">${{ "%.2f"|format(assignment_data.role.hourly_rate) }}/hr</span>
                                            </h5>
                                            <a href="{{ url_for('assign_users_to_role', role_id=role_id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-users-cog"></i> Manage Users
                                            </a>
                                        </div>
                                        
                                        {% if assignment_data.users %}
                                            <div class="row">
                                                {% for user in assignment_data.users %}
                                                    <div class="col-md-3 col-sm-6 mb-2">
                                                        <div class="card card-sm shadow-sm">
                                                            <div class="card-body p-2">
                                                                <small>
                                                                    <strong><i class="fas fa-user"></i> {{ user.full_name or user.username }}</strong>
                                                                    {% if user.full_name and user.username != user.full_name %}
                                                                        <br><span class="text-muted">(@{{ user.username }})</span>
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="alert alert-light mb-0">
                                                <i class="fas fa-info-circle"></i> No users assigned to this role.
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% if not loop.last %}<hr>{% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            <!-- Unassigned Users -->
                            {% if unassigned_users %}
                                <div class="mb-4">
                                    {% if role_assignments %}<hr>{% endif %}
                                    <h5 class="text-warning mb-3">
                                        <i class="fas fa-user-slash"></i> Unassigned Users 
                                        <small class="text-muted">({{ unassigned_users|length }} users)</small>
                                    </h5>
                                    <div class="row">
                                        {% for user in unassigned_users %}
                                            <div class="col-md-3 col-sm-6 mb-2">
                                                <div class="card card-sm border-warning shadow-sm">
                                                    <div class="card-body p-2">
                                                        <small>
                                                            <strong><i class="fas fa-user-question text-warning"></i> {{ user.full_name or user.username }}</strong>
                                                            {% if user.full_name and user.username != user.full_name %}
                                                                <br><span class="text-muted">(@{{ user.username }})</span>
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% elif role_assignments %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> <strong>Great!</strong> All users have been assigned to roles.
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-database"></i> Database Migration Required</h6>
                                <p>The worker role assignment feature requires a database update. The <code>worker_role_id</code> column needs to be added to the User table.</p>
                                <p>Please restart the application to allow the automatic migration to occur, or contact your system administrator.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom CSS -->
    <style>
        .card-sm {
            transition: transform 0.2s ease-in-out;
            border-radius: 8px;
        }
        .card-sm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .card-header h3, .card-header h5 {
            margin-bottom: 0;
        }
        .badge {
            font-size: 0.75em;
        }
        .text-primary {
            color: #0d6efd !important;
        }
        .alert-light {
            border-left: 4px solid #dee2e6;
        }
    </style>

    <script>
        // Add role form submission
        document.getElementById('addRoleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Adding...';
            submitBtn.disabled = true;
            
            fetch('{{ url_for("add_worker_role_from_edit_page") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add new row to table
                    const tableBody = document.getElementById('rolesTableBody');
                    const newRow = createRoleRow(data.role);
                    tableBody.insertAdjacentHTML('beforeend', newRow);
                    
                    // Clear form
                    this.reset();
                    
                    // Show success message
                    showAlert('Role added successfully! Page will refresh to update the overview.', 'success');
                    
                    // Refresh page to update the overview section
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showAlert('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while adding the role.', 'danger');
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
        
        // Function to create a new role row HTML
        function createRoleRow(role) {
            return `
                <tr id="role-${role.id}">
                    <td>${role.id}</td>
                    <td>
                        <span id="role-name-display-${role.id}">${role.name}</span>
                        <input type="text" class="form-control d-none" id="role-name-edit-${role.id}" value="${role.name}">
                    </td>
                    <td>
                        <span id="role-rate-display-${role.id}">$${role.rate.toFixed(2)}</span>
                        <input type="number" class="form-control d-none" id="role-rate-edit-${role.id}" value="${role.rate}" step="0.01" min="0.01">
                    </td>
                    <td>
                        <div id="display-buttons-${role.id}">
                            <button class="btn btn-warning btn-sm me-1" onclick="startEdit(${role.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <a href="/admin_edit_rate/assign_users/${role.id}" class="btn btn-info btn-sm me-1">
                                <i class="fas fa-users"></i> Assign Users
                            </a>
                            <button class="btn btn-danger btn-sm" onclick="removeRole(${role.id}, '${role.name}')">
                                Remove
                            </button>
                        </div>
                        <div id="edit-buttons-${role.id}" class="d-none">
                            <button class="btn btn-success btn-sm me-2" onclick="saveEdit(${role.id})">
                                <i class="fas fa-check"></i> Save
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelEdit(${role.id})">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Start editing a role
        function startEdit(roleId) {
            // Hide display elements and show edit elements
            document.getElementById(`role-name-display-${roleId}`).classList.add('d-none');
            document.getElementById(`role-rate-display-${roleId}`).classList.add('d-none');
            document.getElementById(`display-buttons-${roleId}`).classList.add('d-none');
            
            document.getElementById(`role-name-edit-${roleId}`).classList.remove('d-none');
            document.getElementById(`role-rate-edit-${roleId}`).classList.remove('d-none');
            document.getElementById(`edit-buttons-${roleId}`).classList.remove('d-none');
        }
        
        // Cancel editing a role
        function cancelEdit(roleId) {
            // Show display elements and hide edit elements
            document.getElementById(`role-name-display-${roleId}`).classList.remove('d-none');
            document.getElementById(`role-rate-display-${roleId}`).classList.remove('d-none');
            document.getElementById(`display-buttons-${roleId}`).classList.remove('d-none');
            
            document.getElementById(`role-name-edit-${roleId}`).classList.add('d-none');
            document.getElementById(`role-rate-edit-${roleId}`).classList.add('d-none');
            document.getElementById(`edit-buttons-${roleId}`).classList.add('d-none');
            
            // Reset the input values to original
            const originalName = document.getElementById(`role-name-display-${roleId}`).textContent;
            const originalRate = document.getElementById(`role-rate-display-${roleId}`).textContent.replace('$', '');
            document.getElementById(`role-name-edit-${roleId}`).value = originalName;
            document.getElementById(`role-rate-edit-${roleId}`).value = originalRate;
        }
        
        // Save the edited role
        function saveEdit(roleId) {
            const newName = document.getElementById(`role-name-edit-${roleId}`).value.trim();
            const newRate = document.getElementById(`role-rate-edit-${roleId}`).value;
            
            if (!newName) {
                showAlert('Role name cannot be empty!', 'danger');
                return;
            }
            
            if (!newRate || parseFloat(newRate) <= 0) {
                showAlert('Hourly rate must be greater than 0!', 'danger');
                return;
            }
            
            const formData = new FormData();
            formData.append('name', newName);
            formData.append('hourly_rate', newRate);
            
            // Disable the save button while processing
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            
            fetch(`{{ url_for("edit_worker_role_rate", role_id=0) }}`.replace('0', roleId), {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the display values
                    document.getElementById(`role-name-display-${roleId}`).textContent = data.role.name;
                    document.getElementById(`role-rate-display-${roleId}`).textContent = `$${data.role.rate.toFixed(2)}`;
                    
                    // Switch back to display mode
                    cancelEdit(roleId);
                    
                    showAlert('Role updated successfully! Page will refresh to update the overview.', 'success');
                    
                    // Refresh page to update the overview section
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showAlert('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while updating the role.', 'danger');
            })
            .finally(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }
        
        // Remove role function
        function removeRole(roleId, roleName) {
            if (confirm(`Are you sure you want to remove the role "${roleName}"?`)) {
                fetch(`{{ url_for("remove_worker_role_from_edit_page", role_id=0) }}`.replace('0', roleId), {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove row from table
                        document.getElementById(`role-${roleId}`).remove();
                        showAlert('Role removed successfully! Page will refresh to update the overview.', 'success');
                        
                        // Refresh page to update the overview section
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showAlert('Error: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred while removing the role.', 'danger');
                });
            }
        }
        
        // Show alert function
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.children[1]);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>