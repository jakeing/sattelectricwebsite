<!-- templates/edit_task.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Edit Task - {{ task.name }} - SATT Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* Navbar */
    .navbar-brand img { height: 40px; }
        /* Navbar - Dark Theme */
    .navbar { 
      background-color: #000000 !important;
      border-bottom: 1px solid #333333;
    }

    /* Navbar text colors */
    .navbar-light .navbar-brand,
    .navbar-light .navbar-nav .nav-link {
      color: #ffffff !important;
    }

    .navbar-light .navbar-nav .nav-link:hover {
      color: #66b3ff !important;
    }

    .navbar-light .navbar-toggler {
      border-color: #333333;
    }

    .navbar-light .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    }

    /* Dropdown menus - Dark theme */
    .dropdown-menu { 
      border-radius: .35rem;
      background-color: #1a1a1a;
      border: 1px solid #333333;
    }

    .dropdown-item {
      color: #ffffff;
    }

    .dropdown-item:hover {
      background-color: #333333;
      color: #66b3ff;
    }

    /* Search form styling for dark navbar */
    .navbar .form-control {
      background-color: #2a2a2a;
      border-color: #444444;
      color: #ffffff;
    }

    .navbar .form-control:focus {
      background-color: #333333;
      border-color: #007bff;
      color: #ffffff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .navbar .form-control::placeholder {
      color: #aaaaaa;
    }

    .navbar .btn-outline-primary {
      color: #66b3ff;
      border-color: #66b3ff;
    }

    .navbar .btn-outline-primary:hover {
      background-color: #66b3ff;
      border-color: #66b3ff;
      color: #000000;
    }

    /* Full-width container */
    .container-fluid { max-width: 100%; padding: 0 0.5rem; }

    /* Card styling */
    .card {
      border-radius: .35rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 1.5rem;
    }
    .card-header {
      background-color: #f8f9fa;
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    /* Form styling */
    .form-control {
      border-radius: .25rem;
    }
    .form-control:focus {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    label {
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: #495057;
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    /* Button improvements */
    .btn {
      border-radius: .25rem;
      font-weight: 500;
    }
    
    /* Required field indicator */
    .required-field::after {
      content: "*";
      color: #dc3545;
      margin-left: 0.25rem;
    }
    
    /* Section dividers */
    .section-divider {
      border-top: 1px solid #e9ecef;
      margin: 1.5rem 0;
    }
    
    /* Form sections */
    .form-section {
      margin-bottom: 1rem;
    }
    
    .form-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 1rem;
    }
    
    /* Quick tips card */
    .quick-tips {
      background-color: #e9f7fe;
      border-left: 4px solid #3498db;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: .25rem;
    }
    
    .quick-tips ul {
      padding-left: 1.5rem;
      margin-bottom: 0;
    }
    
    .quick-tips li {
      margin-bottom: 0.5rem;
    }
    
    .quick-tips li:last-child {
      margin-bottom: 0;
    }
    
    /* Select2 customization */
    .select2-container--default .select2-selection--multiple {
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
    }
    .select2-container--default.select2-container--focus .select2-selection--multiple {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
    }
    
    /* Status colors */
    .status-not-started { color: #6c757d; }
    .status-in-progress { color: #fd7e14; }
    .status-completed { color: #28a745; }
    .status-delayed { color: #dc3545; }

    /* Dynamic progress bar widths */
    .progress-dynamic .progress-bar {
    transition: width 0.3s ease;
    }

    /* These will be overridden by JavaScript */
    .progress-bar {
    width: 0%;
    }
  </style>
</head>
<body>

  <!-- Include the existing navigation bar -->
  {% include 'navbar.html' %}

  <div class="container-fluid mt-4">
    <div class="form-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h2 mb-0">Edit Task: {{ task.name }}</h1>
          <p class="text-muted">Project: {{ project.name }}</p>
        </div>
      </div>
      
      {% if error %}
        <div class="alert alert-danger">
          <strong>Error:</strong> {{ error }}
        </div>
      {% endif %}
      
      <div class="row">
        <div class="col-lg-8">
          <!-- Main form card -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Task Details</h5>
            </div>
            <div class="card-body">
              <form method="POST">
                <!-- Task Information Section -->
                <div class="form-section">
                  <div class="form-section-title">Basic Information</div>
                  <div class="form-group">
                    <label for="name" class="required-field">Task Name:</label>
                    <input type="text" id="name" name="name" class="form-control" value="{{ task.name }}" required>
                  </div>
                  <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" class="form-control" rows="3">{{ task.description }}</textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="start_date">Start Date:</label>
                        <input type="date" id="start_date" name="start_date" class="form-control" value="{{ task.start_date.strftime('%Y-%m-%d') if task.start_date else '' }}">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="end_date">End Date:</label>
                        <input type="date" id="end_date" name="end_date" class="form-control" value="{{ task.end_date.strftime('%Y-%m-%d') if task.end_date else '' }}">
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Planning Section -->
                <div class="section-divider"></div>
                <div class="form-section">
                  <div class="form-section-title">Planning & Progress</div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="estimated_hours" class="required-field">Estimated Hours:</label>
                        <input type="number" step="0.1" id="estimated_hours" name="estimated_hours" class="form-control" value="{{ task.estimated_hours }}" required>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="status">Status:</label>
                        <select id="status" name="status" class="form-control">
                          <option value="Not Started" {% if task.status == 'Not Started' %}selected{% endif %}>Not Started</option>
                          <option value="In Progress" {% if task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                          <option value="Completed" {% if task.status == 'Completed' %}selected{% endif %}>Completed</option>
                          <option value="Delayed" {% if task.status == 'Delayed' %}selected{% endif %}>Delayed</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="progress_percent">Progress Percentage:</label>
                      <div class="d-flex align-items-center">
                        <input type="range" class="form-control-range mr-2" id="progress_percent" name="progress_percent" 
                               value="{{ task.progress_percent|default(task.completion_percentage) }}" 
                               min="0" max="100" step="5" style="flex-grow: 1;">
                        <span id="progress_percent_display" class="badge badge-info">{{ task.progress_percent|default(task.completion_percentage) }}%</span>
                      </div>
                      <small class="form-text text-muted">Set the task progress manually (overrides automatic calculation)</small>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="priority">Priority:</label>
                        <select id="priority" name="priority" class="form-control">
                          <option value="Low" {% if task.priority == 'Low' %}selected{% endif %}>Low</option>
                          <option value="Medium" {% if task.priority == 'Medium' %}selected{% endif %}>Medium</option>
                          <option value="High" {% if task.priority == 'High' %}selected{% endif %}>High</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="assigned_to">Assigned To:</label>
                        <select id="assigned_to" name="assigned_to" class="form-control">
                          <option value="">-- Unassigned --</option>
                          {% for user in users %}
                            <option value="{{ user.full_name }}" {% if task.assigned_to == user.full_name %}selected{% endif %}>
                              {{ user.full_name or user.username }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="dependencies">Dependencies:</label>
                    <select id="dependencies" name="dependencies" class="form-control select2-multiple" multiple="multiple">
                      {% if existing_tasks %}
                        {% for existing_task in existing_tasks %}
                          {% if existing_task.id != task.id %}
                            <option value="{{ existing_task.id }}" 
                              {% if task.dependencies and existing_task.id|string in task.dependencies.split(',') %}
                                selected
                              {% endif %}
                            >{{ existing_task.name }}</option>
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    </select>
                    <small class="form-text text-muted">Select tasks that need to be completed before this task can start</small>
                  </div>
                </div>
                
                <div class="form-group mb-0">
                    <button type="submit" class="btn btn-success btn-lg">Save Changes</button>
                    <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-secondary">Cancel</a>
                    
                    <!-- Reset Hours button that opens a modal -->
                    <button type="button" class="btn btn-warning ml-2" data-toggle="modal" data-target="#resetHoursModal">
                      <i class="fas fa-sync-alt mr-1"></i> Reset Actual Hours
                    </button>
                    
                    <!-- Delete Task button that opens a modal -->
                    <button type="button" class="btn btn-danger ml-2" data-toggle="modal" data-target="#deleteTaskModal">
                      <i class="fas fa-trash mr-1"></i> Delete Task
                    </button>
                  </div>
              </form>
              <!-- Reset Hours Modal -->
              <div class="modal fade" id="resetHoursModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Reset Actual Hours</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <form action="{{ url_for('reset_task_hours', task_id=task.id) }}" method="POST">
                      <div class="modal-body">
                        <p>Current actual hours: <strong>{{ task.actual_hours }}</strong></p>
                        <p>Update to a new value:</p>
                        <div class="form-group">
                          <label for="actual_hours_reset">New Actual Hours:</label>
                          <input type="number" step="0.1" name="actual_hours" id="actual_hours_reset" class="form-control" value="{{ task.actual_hours }}" required>
                          <small class="form-text text-muted">This will reset the hours stored for this task, separate from individual time entries.</small>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Reset Hours</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Delete Task Modal -->
              <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Delete Task</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST">
                      <div class="modal-body">
                        <div class="alert alert-danger">
                          <i class="fas fa-exclamation-triangle mr-2"></i>
                          <strong>Warning:</strong> Are you sure you want to delete this task?
                        </div>
                        <p>Task Name: <strong>{{ task.name }}</strong></p>
                        <p>This will permanently remove the task. Any time entries associated with this task will be kept but will no longer be linked to this task.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Task</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <!-- Task Progress Card -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Task Progress</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-4 text-center">
                  <div class="h5 mb-0">{{ task.estimated_hours }}</div>
                  <div class="small text-muted">Estimated</div>
                </div>
                <div class="col-4 text-center">
                  <div class="h5 mb-0">{{ task.actual_hours }}</div>
                  <div class="small text-muted">Logged</div>
                </div>
                <div class="col-4 text-center">
                  <div class="h5 mb-0 {% if task.hours_remaining < 0 %}text-danger{% endif %}">
                    {{ task.hours_remaining|round(1) }}
                  </div>
                  <div class="small text-muted">Remaining</div>
                </div>
              </div>
              
              <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span>Completion:</span>
                  <span>{{ task.completion_percentage }}%</span>
                </div>
                  <div class="progress progress-dynamic mb-2">
                    <div class="progress-bar bg-success" role="progressbar" 
                         data-percentage="{{ task.completion_percentage|default(0) }}"
                         aria-valuenow="{{ task.completion_percentage|default(0) }}"
                         aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
              </div>
              
              <div class="section-divider"></div>
              
              <!-- Quick Tips -->
              <div class="quick-tips">
                <h6 class="font-weight-bold mb-2">Task Tips</h6>
                <ul>
                  <li><strong>Status updates:</strong> Regularly update the task status to keep the project on track.</li>
                  <li><strong>Dependencies:</strong> Be careful when modifying dependencies as this can affect the project timeline.</li>
                  <li><strong>Completion:</strong> Tasks are automatically marked at 100% when their status is set to "Completed".</li>
                </ul>
              </div>
              
              <div class="mt-4">
                <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-outline-secondary btn-block">Back to Project</a>
                <a href="{{ url_for('project_gantt', project_id=project.id) }}" class="btn btn-outline-info btn-block mt-2">View Gantt Chart</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    $(document).ready(function() {
      // Initialize Select2 for dependencies
      $('.select2-multiple').select2({
        placeholder: 'Select dependent tasks',
        width: '100%'
      });
      
      // Change status color based on selection
      $('#status').change(function() {
        var status = $(this).val();
        $(this).removeClass('status-not-started status-in-progress status-completed status-delayed');
        $(this).addClass('status-' + status.toLowerCase().replace(' ', '-'));
        
        // If status is set to Completed, update the warning text
        if (status === 'Completed') {
          if (!$('#completion-warning').length) {
            $(this).after('<small id="completion-warning" class="form-text text-success mt-1"><i class="fas fa-check-circle mr-1"></i> Task will be marked as 100% complete.</small>');
          }
        } else {
          $('#completion-warning').remove();
        }
      });
      
      // Trigger status change on page load to set initial color
      $('#status').trigger('change');
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set progress bar widths from data attributes
      document.querySelectorAll('.progress-bar[data-percentage]').forEach(function(bar) {
        var percentage = bar.getAttribute('data-percentage');
        bar.style.width = percentage + '%';
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const progressSlider = document.getElementById('progress_percent');
      const progressDisplay = document.getElementById('progress_percent_display');
      const statusSelect = document.getElementById('status');
      
      // Update progress display when slider moves
      progressSlider.addEventListener('input', function() {
        progressDisplay.textContent = this.value + '%';
      });
      
      // Set progress to 100% when status is set to Completed
      statusSelect.addEventListener('change', function() {
        if (this.value === 'Completed') {
          progressSlider.value = 100;
          progressDisplay.textContent = '100%';
        }
      });
    });
  </script>
</body>
</html>