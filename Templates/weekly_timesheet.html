<!doctype html>
<html lang="en">
<head>
  <script>
    function getDayAbbr(dayOfWeek) {
      switch(dayOfWeek) {
        case 'Mon': return 'Mon';
        case 'Tue': return 'Tue';
        case 'Wed': return 'Wed';
        case 'Thu': return 'Thu';
        case 'Fri': return 'Fri';
        case 'Sat': return 'Sat';
        case 'Sun': return 'Sun';
        default: return dayOfWeek.charAt(0);
      }
    }
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Week {{ week }} {{ year }} Timesheet - SATT Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
  
  <style>
  /* ==========================================================================
     NAVBAR & NAVIGATION
     ========================================================================== */

  .navbar-brand img { 
    height: 40px; 
  }

  .dropdown-menu { 
    border-radius: .35rem; 
  }
      /* Navbar - Dark Theme */
    .navbar { 
      background-color: #000000 !important;
      border-bottom: 1px solid #333333;
    }

    /* Navbar text colors */
    .navbar-light .navbar-brand,
    .navbar-light .navbar-nav .nav-link {
      color: #ffffff !important;
    }

    .navbar-light .navbar-nav .nav-link:hover {
      color: #66b3ff !important;
    }

    .navbar-light .navbar-toggler {
      border-color: #333333;
    }

    .navbar-light .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    }

    /* Dropdown menus - Dark theme */
    .dropdown-menu { 
      border-radius: .35rem;
      background-color: #1a1a1a;
      border: 1px solid #333333;
    }

    .dropdown-item {
      color: #ffffff;
    }

    .dropdown-item:hover {
      background-color: #333333;
      color: #66b3ff;
    }

    /* Search form styling for dark navbar */
    .navbar .form-control {
      background-color: #2a2a2a;
      border-color: #444444;
      color: #ffffff;
    }

    .navbar .form-control:focus {
      background-color: #333333;
      border-color: #007bff;
      color: #ffffff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .navbar .form-control::placeholder {
      color: #aaaaaa;
    }

    .navbar .btn-outline-primary {
      color: #66b3ff;
      border-color: #66b3ff;
    }

    .navbar .btn-outline-primary:hover {
      background-color: #66b3ff;
      border-color: #66b3ff;
      color: #000000;
    }

  /* ==========================================================================
     LAYOUT & CONTAINERS
     ========================================================================== */
  .container-fluid { 
    max-width: 100%; 
    padding: 0 0.5rem; 
  }

  .sticky-top {
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  /* ==========================================================================
     CARDS & CONTAINERS
     ========================================================================== */
  .card {
    border-radius: .35rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 1.5rem;
  }

  .card-header {
    background-color: #f8f9fa;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
  }

  /* Date range card */
  .date-range-card {
    background-color: #ffffff;
    border-radius: .35rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .date-range-display {
    display: flex;
    align-items: center;
    font-size: 1.1rem;
    color: #495057;
  }

  .date-controls {
    display: flex;
    align-items: center;
  }

  .date-nav-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    margin: 0 0.25rem;
    transition: all 0.2s ease;
  }

  .date-nav-btn:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
  }

  /* Summary card styles */
  .summary-card {
    background-color: #f8f9fa;
    border-radius: .35rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    padding: 1rem;
    margin-bottom: 1.5rem;
  }

  .summary-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.5rem;
  }

  .total-hours-display {
    font-size: 2rem;
    font-weight: 700;
    color: #495057;
    text-align: center;
    margin: 1rem 0;
  }

  .hours-by-day {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
  }

  .day-hours {
    text-align: center;
    flex: 1;
  }

  .day-name {
    font-size: 0.8rem;
    color: #6c757d;
  }

  .day-value {
    font-size: 1.1rem;
    font-weight: 600;
  }

  /* ==========================================================================
     TABLES
     ========================================================================== */
  .table-responsive { 
    overflow-x: auto; 
  }

  .table { 
    width: 100%; 
    table-layout: auto;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-hover tbody tr:hover { 
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
  }

  /* Locked entry styling - prevent hover on locked entries */
  .table-hover tbody tr.table-warning:hover {
    background-color: #fff3cd !important;
    transform: none;
    box-shadow: none;
  }

  .table thead th {
    font-size: .85rem;
    vertical-align: middle;
    text-align: center;
    white-space: nowrap;
    padding: .5rem .75rem;
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 1;
    border-top: none;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
  }

  .table tbody td {
    vertical-align: middle;
    padding: .65rem .75rem;
    font-size: .9rem;
    border-top: 1px solid #f0f0f0;
  }

  /* Alternate row highlighting */
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.025);
  }

  /* Locked entry styling overrides normal striping */
  .table-striped tbody tr.table-warning:nth-of-type(odd),
  .table-striped tbody tr.table-warning:nth-of-type(even) {
    background-color: #fff3cd !important;
  }

  /* Time adjustment styling overrides */
  .table-striped tbody tr.time-adjustment-row:nth-of-type(odd),
  .table-striped tbody tr.time-adjustment-row:nth-of-type(even) {
    background-color: #fff3cd !important;
  }

  /* Hours cell highlighting */
  .hours-cell {
    font-weight: 600;
    color: #495057;
    text-align: center;
  }

  .hours-negative {
    color: #dc3545;
    font-weight: 600;
  }

  .hours-positive {
    color: #28a745;
    font-weight: 600;
  }

  /* ==========================================================================
     TIME ENTRY STATES
     ========================================================================== */
  /* Entry row statuses */
  tr.entry-completed {
    background-color: rgba(40, 167, 69, 0.1) !important;
  }

  tr.entry-completed td {
    color: #495057;
  }

  /* Time adjustment entries */
  .time-adjustment-row {
    background-color: #fff3cd !important;
    border-left: 4px solid #ffc107;
  }

  .time-adjustment-row:hover {
    background-color: #ffeaa7 !important;
  }

  .time-adjustment-badge {
    background-color: #ffc107;
    color: #212529;
    font-weight: 600;
    font-size: 0.75rem;
    padding: 0.25em 0.5em;
    border-radius: 0.25rem;
  }

  /* Locked time entry styling */
  .table-warning .text-muted {
    opacity: 0.7;
  }

  /* Lock icon styling */
  .fa-lock.text-warning {
    font-size: 0.8rem;
  }

  /* ==========================================================================
     DAY INDICATORS & BADGES
     ========================================================================== */
  .day-indicator {
    display: inline-block;
    min-width: 40px;
    height: 24px;
    line-height: 24px;
    border-radius: 12px;
    text-align: center;
    margin-right: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0 5px;
  }

  .weekday {
    background-color: #e9ecef;
    color: #495057;
  }

  .weekend {
    background-color: #ffddc7;
    color: #fd7e14;
  }

  /* Badge styles */
  .badge-custom {
    padding: 0.4rem 0.6rem;
    border-radius: 50rem;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .badge-info-light {
    background-color: #e1f5fe;
    color: #0288d1;
  }

  .badge-success-light {
    background-color: #e8f5e9;
    color: #388e3c;
  }

  .badge-billable {
    background-color: #e8f5e9;
    color: #28a745;
  }

  .badge-non-billable {
    background-color: #fff3cd;
    color: #856404;
  }

  .badge-contract-project {
    background-color: #e1f5fe;
    color: #0288d1;
  }

  /* Engineer tag style */
  .engineer-tag {
    display: inline-block;
    background-color: #e9ecef;
    color: #495057;
    padding: 0.35rem 0.7rem;
    border-radius: 50rem;
    font-size: 0.85rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  /* ==========================================================================
     CLASSIFICATION COLOR CODING
     ========================================================================== */
  .classification-billable {
    background-color: rgba(40, 167, 69, 0.15) !important;
    border-left: 3px solid #28a745;
  }

  .classification-non-billable {
    background-color: rgba(255, 193, 7, 0.15) !important;
    border-left: 3px solid #ffc107;
  }

  .classification-contract-project {
    background-color: rgba(0, 123, 255, 0.15) !important;
    border-left: 3px solid #007bff;
  }

  /* ==========================================================================
     FORMS & BUTTONS
     ========================================================================== */
  .form-inline .form-control {
    width: auto;
    display: inline-block;
    vertical-align: middle;
    margin-right: 0.5rem;
  }

  .btn-group-sm > .btn, .btn-sm {
    padding: 0.3rem 0.5rem;
    font-size: 0.875rem;
    border-radius: .2rem;
  }

  .btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  /* Quick Action Links */
  .quick-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .quick-actions .btn {
    flex: 1;
    text-align: center;
    padding: 0.75rem 0.5rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.35rem;
    color: #495057;
    transition: all 0.2s ease;
  }

  .quick-actions .btn:hover {
    background-color: #e9ecef;
    color: #212529;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .quick-actions .btn i {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  /* ==========================================================================
     CHECKBOXES
     ========================================================================== */
  .custom-checkbox-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 32px;
  }

  .custom-checkbox {
    position: relative;
    width: 28px;
    height: 28px;
    cursor: pointer;
  }

  .custom-checkbox input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
  }

  .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 24px;
    width: 24px;
    background-color: #eee;
    border-radius: 4px;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
  }

  .custom-checkbox:hover input ~ .checkmark {
    background-color: #ccc;
  }

  .custom-checkbox input:checked ~ .checkmark {
    background-color: #28a745;
    border-color: #28a745;
  }

  .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 9px;
    top: 5px;
    width: 6px;
    height: 12px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    transition: all 0.2s ease;
  }

  .custom-checkbox input:checked ~ .checkmark:after {
    display: block;
  }

  tr.entry-completed .checkmark {
    background-color: #28a745;
    border-color: #28a745;
  }

  tr.entry-completed .checkmark:after {
    display: block;
  }

  /* ==========================================================================
     VIEW TOGGLE & CALENDAR
     ========================================================================== */
  .view-toggle {
    display: flex;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .view-toggle .btn {
    border-radius: 0;
  }

  .view-toggle .btn:first-child {
    border-top-left-radius: .25rem;
    border-bottom-left-radius: .25rem;
  }

  .view-toggle .btn:last-child {
    border-top-right-radius: .25rem;
    border-bottom-right-radius: .25rem;
  }

  /* Calendar view controls */
  .calendar-view {
    display: none !important;
  }

  .calendar-view.active {
    display: block !important;
  }

  /* Hide calendar elements when NOT in calendar view */
  body:not(.calendar-active) .calendar-day,
  body:not(.calendar-active) .calendar-container:not(.summary-grid),
  body:not(.calendar-active) .calendar-header {
    display: none !important;
  }

  /* Calendar layout */
  .calendar-container {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
  }

  .calendar-header {
    text-align: center;
    padding: 0.5rem;
    font-weight: 600;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
  }

  .calendar-day {
    border: 1px solid #dee2e6;
    border-radius: 0.35rem;
    min-height: 100px;
    padding: 0.5rem;
    display: none; /* Hidden by default, shown only in calendar view */
  }

  .calendar-view .calendar-day {
    display: block;
  }

  .calendar-day.weekend {
    background-color: #fff8f3;
  }

  .calendar-day.today {
    border: 2px solid #007bff;
  }

  .day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 0.25rem;
    margin-bottom: 0.5rem;
  }

  .day-date {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .day-total {
    font-size: 0.8rem;
    background-color: #e9ecef;
    padding: 0.1rem 0.4rem;
    border-radius: 50rem;
  }

  .day-entries {
    font-size: 0.8rem;
  }

  .calendar-entry {
    background-color: #f0f4ff;
    border-left: 3px solid #007bff;
    border-radius: 0.25rem;
    padding: 0.25rem;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    position: relative;
  }

  .calendar-entry-engineer {
    font-size: 0.7rem;
    opacity: 0.8;
    font-style: italic;
    margin-right: 3px;
  }

  /* ==========================================================================
     CHARTS
     ========================================================================== */
  .chart-container {
    position: relative;
    width: 100%;
    height: 200px;
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  /* Force charts to stay within their containers */
  .chart-container canvas {
    position: relative !important;
    width: 100% !important;
    height: 200px !important;
    max-width: 100% !important;
  }

  #hoursByDayChart,
  #hoursByTypeChart {
    width: 100% !important;
    height: 200px !important;
    max-width: 100% !important;
  }

  /* ==========================================================================
     SUMMARY & STATS
     ========================================================================== */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .summary-item {
    background-color: #fff;
    border-radius: 0.35rem;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.05);
  }

  .summary-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
  }

  .summary-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #495057;
  }

  /* ==========================================================================
     MODALS
     ========================================================================== */
  .entries-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }

  .entries-modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #dee2e6;
    border-radius: 0.35rem;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .entries-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .entries-modal-close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .entries-modal-close:hover,
  .entries-modal-close:focus {
    color: #000;
    text-decoration: none;
  }

  .modal-entry-item {
    padding: 8px;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 8px;
  }

  .modal-entry-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  /* ==========================================================================
     NOTIFICATIONS
     ========================================================================== */
  .toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #28a745;
    color: white;
    padding: 10px 15px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1050;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .toast-notification.show {
    opacity: 1;
  }

  /* ==========================================================================
     EMPTY STATES
     ========================================================================== */
  .empty-state {
    text-align: center;
    padding: 2rem 1rem;
  }

  /* ==========================================================================
     MOBILE RESPONSIVE
     ========================================================================== */
  @media (max-width: 767px) {
    .mobile-p-0 { 
      padding: 0 !important; 
    }
    
    .mobile-p-1 { 
      padding: 0.25rem !important; 
    }
    
    /* Maintain table structure on mobile */
    .table { 
      min-width: 1200px; 
    }
    
    /* Improved touch targets */
    .btn-sm {
      padding: 0.3rem 0.4rem;
      font-size: 0.875rem;
    }
    
    /* Fix navbar on mobile */
    .navbar-collapse {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    /* Responsive quick actions */
    .quick-actions {
      flex-wrap: wrap;
    }
    
    .quick-actions .btn {
      flex: 1 1 calc(50% - 0.25rem);
      margin-bottom: 0.5rem;
    }
    
    /* Chart containers on mobile */
    .chart-container {
      height: 150px;
    }
    
    .chart-container canvas {
      height: 150px !important;
    }
  }

  /* ==========================================================================
     PRINT STYLES
     ========================================================================== */
  @media print {
    .quick-actions,
    .view-toggle,
    .btn,
    .navbar {
      display: none !important;
    }
    
    .card {
      box-shadow: none;
      border: 1px solid #dee2e6;
    }
    
    .table {
      font-size: 0.8rem;
    }
  }
  </style>
</head>
<body>

  <!-- Navbar with multi-tenancy support -->
  {% include 'navbar.html' %}

  <!-- User data for JavaScript -->
  <div id="user-data" data-is-admin="{{ 'true' if session.get('user_role', '')|lower == 'admin' else 'false' }}" style="display:none;"></div>

  <!-- Toast Notification -->
  <div id="toastNotification" class="toast-notification">
    <i class="fas fa-check-circle mr-2"></i> <span id="toastText">Changes saved successfully!</span>
  </div>

  <div class="container-fluid mt-3">
    <!-- Page Header and Date Navigation -->
    <div class="date-range-card">
      <div>
        <h1 class="h3 mb-0">Weekly Timesheet</h1>
        <div class="date-range-display">
          <span class="badge badge-custom badge-info-light mr-2">Week {{ week }}</span>
          <span class="badge badge-custom badge-info-light mr-2">{{ year }}</span>
          <i class="far fa-calendar-alt mr-2"></i> 
          <span>{{ start_date.strftime('%b %d') }} - {{ last_date.strftime('%b %d, %Y') }}</span>
        </div>
      </div>
      <div class="date-controls">
        <a href="{{ url_for('view_weekly_timesheet', year=year, week=week-1 if week > 1 else 52) }}" class="date-nav-btn">
          <i class="fas fa-chevron-left"></i>
        </a>
        <a href="{{ url_for('view_weekly_timesheet', year=year, week=week+1 if week < 52 else 1) }}" class="date-nav-btn">
          <i class="fas fa-chevron-right"></i>
        </a>
        <a href="{{ url_for('view_weekly_timesheet', year=year, week=(datetime.now().isocalendar()[1])) }}" class="date-nav-btn">
          <i class="fas fa-calendar-day"></i>
        </a>
      </div>
    </div>
    
    <div class="row">
      <div class="col-lg-9">
        <!-- View Toggle -->
        <div class="view-toggle">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" id="list-view-btn">
              <i class="fas fa-list mr-1"></i> List View
            </button>
            <button type="button" class="btn btn-outline-primary" id="calendar-view-btn">
              <i class="fas fa-calendar-alt mr-1"></i> Calendar View
            </button>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
          <a href="{{ url_for('new_timesheet') }}" class="btn">
            <i class="fas fa-plus-circle"></i>
            Add Entries
          </a>
          <a href="{{ url_for('export_timesheet', year=year, week=week, engineer=request.args.get('engineer', '')) }}" class="btn">
            <i class="fas fa-file-excel"></i>
            Export Excel
          </a>
          <a href="#" class="btn" id="print-timesheet-btn">
            <i class="fas fa-print"></i>
            Print View
          </a>
          <a href="{{ url_for('select_weekly_timesheet') }}" class="btn">
            <i class="fas fa-calendar-week"></i>
            Change Week
          </a>
        </div>
        
        <!-- Filter Controls -->
        <div class="card mb-4">
          <div class="card-body p-3">
            <form method="get" class="form-inline">
              <div class="input-group mr-2 mb-2 mb-md-0">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-user"></i></span>
                </div>
                <input type="text" name="engineer" class="form-control" placeholder="Filter by Engineer" value="{{ request.args.get('engineer', '') }}">
              </div>
              
              <button type="submit" class="btn btn-primary mb-2 mb-md-0 mr-2">Apply Filters</button>
              
              {% if request.args.get('engineer', '') or request.args.get('status', '') %}
                <a href="{{ url_for('view_weekly_timesheet', year=year, week=week) }}" class="btn btn-outline-secondary mb-2 mb-md-0">Clear Filters</a>
              {% endif %}
            </form>
          </div>
        </div>
        
        <!-- Protection Notice -->
        <div class="alert alert-info">
          <i class="fas fa-info-circle mr-2"></i>
          <strong>Note:</strong> Time entries marked with JL (Job Log) or JT (Job Time) are protected from deletion and reassignment as they have been entered into the accounting system.
        </div>
        
        <!-- Main Content - List View -->
        <div class="card" id="list-view">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Time Entries</h5>
            <div class="d-flex align-items-center">
              <span class="badge badge-custom badge-success-light mr-2">
                {{ time_entries|length }} Entries
              </span>
              <span class="badge badge-custom badge-info-light">
                {{ total_hours | round(1) }} Hours
              </span>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th class="text-center" style="width: 40px;">#</th>
                    <th>
                      <a href="{{ url_for('view_weekly_timesheet', year=year, week=week, sort_by='engineer', order=('desc' if sort_by=='engineer' and order=='asc' else 'asc')) }}" class="text-dark">
                        Engineer
                        {% if sort_by == 'engineer' %}
                          {% if order == 'asc' %}<i class="fas fa-sort-up ml-1"></i>{% else %}<i class="fas fa-sort-down ml-1"></i>{% endif %}
                        {% endif %}
                      </a>
                    </th>
                    <th>Work Order</th>
                    <th>
                      <a href="{{ url_for('view_weekly_timesheet', year=year, week=week, sort_by='work_date', order=('desc' if sort_by=='work_date' and order=='asc' else 'asc')) }}" class="text-dark">
                        Date
                        {% if sort_by == 'work_date' %}
                          {% if order == 'asc' %}<i class="fas fa-sort-up ml-1"></i>{% else %}<i class="fas fa-sort-down ml-1"></i>{% endif %}
                        {% endif %}
                      </a>
                    </th>
                    <th class="text-center">Time In</th>
                    <th class="text-center">Time Out</th>
                    <th class="text-center">Hours</th>
                    <th>Description</th>
                    <th class="text-center" title="Entered in Job Listing">JL</th>
                    <th class="text-center" title="Entered in Job Totals">JT</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in time_entries %}
                  <!-- Check if entry is locked -->
                  {% set is_locked = entry.entered_on_jl or entry.entered_on_jt %}
                  <!-- Check if entry is a time adjustment -->
                  {% set is_adjustment = entry.engineer == 'timeadj' %}
                  <!-- Check if current user is admin -->
                  {% set is_admin = session.get('user_id') and (User.query.get(session.get('user_id')).role.lower() == 'admin' or User.query.get(session.get('user_id')).username.lower() == 'admin') %}

                  <!-- Only show time adjustment entries to admin users -->
                  {% if not is_adjustment or is_admin %}

                  <tr id="entry-{{ entry.id }}" 
                    class="{% if entry.entered_on_jl and entry.entered_on_jt %}entry-completed{% endif %}{% if is_locked %} table-warning{% endif %}{% if is_adjustment %} time-adjustment-row{% endif %}">
                      <td class="text-center">
                        {{ entry.id }}
                        {% if is_locked %}
                          <i class="fas fa-lock text-warning ml-1" title="Entry locked - entered in accounting system"></i>
                        {% endif %}
                        {% if is_adjustment %}
                          <br><span class="time-adjustment-badge">ADJ</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if is_adjustment %}
                          <span class="time-adjustment-badge">Time Adjustment</span>
                        {% else %}
                          <span class="engineer-tag">{{ entry.engineer }}</span>
                        {% endif %}
                      </td>
                      <td>
                        <a href="{{ url_for('work_order_detail', work_order_id=entry.work_order.id) }}" class="font-weight-medium">
                          {{ entry.work_order.satt_job_number }}
                        </a>
                        <small class="d-block text-muted">{{ entry.work_order.customer_work_order_number or 'N/A' }}</small>
                        
                        <!-- Only show classification badge for admin users -->
                        {% if session.get('user_role','')|lower == 'admin' %}
                        <span class="badge badge-{{ entry.work_order.classification|lower|replace('/', '-') }} d-block mt-1">
                          {{ entry.work_order.classification }}
                        </span>
                        {% endif %}
                      </td>
                        <td>
                          {% set day_of_week = entry.work_date.strftime('%a') %}
                          {% set is_weekend = day_of_week in ['Sat', 'Sun'] %}
                          <div>
                            <span class="day-indicator {{ 'weekend' if is_weekend else 'weekday' }}">
                              {{ day_of_week[:3] }}
                            </span>
                            {{ entry.work_date.strftime('%Y-%m-%d') }}
                          </div>
                        </td>
                      <td class="text-center">
                        {% if is_adjustment %}
                          <span class="text-muted">—</span>
                        {% else %}
                          {{ entry.time_in.strftime('%H:%M') }}
                        {% endif %}
                      </td>
                      <td class="text-center">
                        {% if is_adjustment %}
                          <span class="text-muted">—</span>
                        {% else %}
                          {{ entry.time_out.strftime('%H:%M') }}
                        {% endif %}
                      </td>
                      <td class="hours-cell">
                        {% if entry.hours_worked < 0 %}
                          <span class="hours-negative">{{ entry.hours_worked | round(2) }}</span>
                        {% elif entry.hours_worked > 0 and is_adjustment %}
                          <span class="hours-positive">+{{ entry.hours_worked | round(2) }}</span>
                        {% else %}
                          {{ entry.hours_worked | round(2) }}
                        {% endif %}
                      </td>
                      <td>{{ entry.description or '-' }}</td>
                      <!-- Checkbox for JL -->
                      <td>
                        {% if is_adjustment %}
                          <span class="text-muted">N/A</span>
                        {% else %}
                          <div class="custom-checkbox-container">
                            <label class="custom-checkbox">
                              <input type="checkbox" class="entry-check jl-check" data-entry-id="{{ entry.id }}" 
                                    {% if entry.entered_on_jl %}checked{% endif %}>
                              <span class="checkmark"></span>
                            </label>
                          </div>
                        {% endif %}
                      </td>
                      <!-- Checkbox for JT -->
                      <td>
                        {% if is_adjustment %}
                          <span class="text-muted">N/A</span>
                        {% else %}
                          <div class="custom-checkbox-container">
                            <label class="custom-checkbox">
                              <input type="checkbox" class="entry-check jt-check" data-entry-id="{{ entry.id }}" 
                                    {% if entry.entered_on_jt %}checked{% endif %}>
                              <span class="checkmark"></span>
                            </label>
                          </div>
                        {% endif %}
                      </td>
                      <!-- Actions -->
                      <td class="text-center">
                        {% if is_adjustment %}
                          <!-- Time adjustment entries - special handling -->
                          <div class="btn-group btn-group-sm">
                            {% if is_admin %}
                              <form action="{{ url_for('delete_time_entry', time_entry_id=entry.id) }}" 
                                    method="POST" 
                                    style="display:inline;" 
                                    onsubmit="return confirm('Are you sure you want to delete this time adjustment?');">
                                <button type="submit" class="btn btn-outline-danger" title="Delete Adjustment">
                                  <i class="fas fa-trash-alt"></i>
                                </button>
                              </form>
                            {% else %}
                              <span class="text-muted">Admin Only</span>
                            {% endif %}
                          </div>
                        {% elif is_locked %}
                          <!-- Locked entry - show disabled buttons with tooltips -->
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" 
                                    disabled 
                                    title="Cannot reassign - entry locked in accounting system">
                              <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-outline-secondary" 
                                    disabled 
                                    title="Cannot delete - entry locked in accounting system">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                          </div>
                        {% else %}
                          <!-- Normal entry - show active buttons -->
                          <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('reassign_time_entry', time_entry_id=entry.id) }}" class="btn btn-outline-info" title="Reassign Entry">
                              <i class="fas fa-exchange-alt"></i>
                            </a>
                            <form action="{{ url_for('delete_time_entry', time_entry_id=entry.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this time entry?');">
                              <button type="submit" class="btn btn-outline-danger" title="Delete Entry">
                                <i class="fas fa-trash-alt"></i>
                              </button>
                            </form>
                          </div>
                        {% endif %}
                      </td>
                    </tr>
                    
                    {% endif %} <!-- End admin check for time adjustments -->
                  {% endfor %}
                  
                  {% if not time_entries %}
                    <tr>
                      <td colspan="11" class="text-center py-4">
                        <div class="empty-state">
                          <i class="far fa-clock mb-3" style="font-size: 3rem; color: #dee2e6;"></i>
                          <h5>No Time Entries Found</h5>
                          <p class="text-muted">There are no time entries for this week with the current filters.</p>
                          <a href="{{ url_for('new_timesheet') }}" class="btn btn-primary mt-2">
                            <i class="fas fa-plus-circle mr-1"></i> Add New Time Entries
                          </a>
                        </div>
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
                
                <!-- Table Footer with Totals -->
                <tfoot>
                  <tr class="bg-light">
                    <td colspan="6" class="text-right font-weight-bold">Total Hours:</td>
                    <td class="hours-cell">{{ total_hours | round(2) }}</td>
                    <td colspan="4"></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Calendar View (Hidden by Default) -->
        <div class="card calendar-view" id="calendar-view">
          <div class="card-header">
            <h5 class="mb-0">Weekly Calendar View</h5>
          </div>
          <div class="card-body">
            <!-- Calendar Headers -->
            <div class="calendar-container mb-2">
              {% for day_name in ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                <div class="calendar-header">{{ day_name }}</div>
              {% endfor %}
            </div>
            
            <!-- Calendar Days -->
            <div class="calendar-container">
              {% for i in range(7) %}
                {% set current_date = start_date + timedelta(days=i) %}
                {% set is_weekend = current_date.weekday() >= 5 %}
                {% set is_today = current_date == today_date %}
                
                {% set day_entries = [] %}
                {% for entry in time_entries %}
                  {% set is_adjustment = entry.engineer == 'timeadj' %}
                  {% set is_admin = session.get('user_id') and (User.query.get(session.get('user_id')).role.lower() == 'admin' or User.query.get(session.get('user_id')).username.lower() == 'admin') %}
                  {% if entry.work_date == current_date and (not is_adjustment or is_admin) %}
                    {% set _ = day_entries.append(entry) %}
                  {% endif %}
                {% endfor %}
                {% set day_total = day_entries|sum(attribute='hours_worked') %}
                
                <div class="calendar-day{% if is_weekend %} weekend{% endif %}{% if is_today %} today{% endif %}">
                  <div class="day-header">
                    <div class="day-date">{{ current_date.strftime('%d') }}</div>
                    {% if day_total > 0 %}
                      <div class="day-total">{{ day_total | round(1) }}h</div>
                    {% endif %}
                  </div>
                  
                  <div class="day-entries">
                    {% for entry in day_entries[:3] %}
                      {% set is_adjustment = entry.engineer == 'timeadj' %}
                      <div class="calendar-entry {% if session.get('user_role','')|lower == 'admin' %}classification-{{ entry.work_order.classification|lower|replace('/', '-') }}{% endif %}{% if is_adjustment %} time-adjustment-row{% endif %}" 
                          title="{{ entry.work_order.satt_job_number }} - {{ entry.hours_worked }} hours{% if session.get('user_role','')|lower == 'admin' %} - {{ entry.work_order.classification }}{% endif %}{% if entry.description %} - {{ entry.description }}{% endif %}">
                        {% if is_adjustment %}
                          <span class="calendar-entry-engineer time-adjustment-badge">ADJ</span>
                        {% else %}
                          <span class="calendar-entry-engineer">{{ entry.engineer }}</span>
                          {{ entry.time_in.strftime('%H:%M') }}-{{ entry.time_out.strftime('%H:%M') }}
                        {% endif %}
                        <span class="small">
                          {% if entry.hours_worked < 0 %}
                            <span class="hours-negative">{{ entry.hours_worked | round(1) }}h</span>
                          {% elif entry.hours_worked > 0 and is_adjustment %}
                            <span class="hours-positive">+{{ entry.hours_worked | round(1) }}h</span>
                          {% else %}
                            {{ entry.hours_worked | round(1) }}h
                          {% endif %}
                        </span>
                      </div>
                    {% endfor %}
                    
                    {% if day_entries|length > 3 %}
                      <div class="text-center small mt-1">
                        <a href="#" class="text-muted view-more-entries" 
                           data-date="{{ current_date.strftime('%Y-%m-%d') }}"
                           data-entries="{{ day_entries|length }}">
                          +{{ day_entries|length - 3 }} more
                        </a>
                      </div>
                    {% endif %}
                  </div>                  
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3">
        <!-- Timesheet Summary -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Weekly Summary</h5>
          </div>
          <div class="card-body">
            <div class="total-hours-display">
              {{ total_hours | round(1) }} <small>hrs</small>
            </div>
            
            <!-- Hours by Day Chart -->
            <div class="chart-container">
              <canvas id="hoursByDayChart"></canvas>
            </div>
            
            {% if session.get('user_role','')|lower == 'admin' %}
            <div class="chart-container mt-4">
              <canvas id="hoursByTypeChart"></canvas>
            </div>
            {% endif %}
            
            <!-- Detailed Stats -->
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">Entries</div>
                <div class="summary-value">{{ time_entries|length }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Work Orders</div>
                <div class="summary-value">{{ time_entries|map(attribute='work_order_id')|unique|list|length }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Avg Hours/Day</div>
                <div class="summary-value">{{ (total_hours / 5) | round(1) if total_hours > 0 else 0 }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Completion</div>
                <div class="summary-value" id="completion-percentage">0%</div>
              </div>
            </div>
            
            <!-- Timesheet Legend -->
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="font-weight-bold mb-2">Timesheet Legend</h6>
                <!-- Entry status indicators -->
                <div class="d-flex align-items-center mb-2">
                  <div style="width: 20px; height: 20px; background-color: rgba(40, 167, 69, 0.1);" class="mr-2 rounded"></div>
                  <span>Entries in both systems</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <div style="width: 20px; height: 20px; background-color: #fff3cd;" class="mr-2 rounded border border-warning"></div>
                  <span>Entries locked in system</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <div style="width: 20px; height: 20px; background-color: #fff;" class="mr-2 rounded border"></div>
                  <span>Entries pending system entry</span>
                </div>
                <p class="small mb-0 text-muted">Check the boxes to mark entries as entered in the respective systems.</p>
                {% if session.get('user_role','')|lower == 'admin' %}
                <div class="d-flex align-items-center mb-2">
                  <div style="width: 20px; height: 20px; background-color: #fff3cd; border-left: 4px solid #ffc107;" class="mr-2 rounded"></div>
                  <span>Time adjustments</span>
                </div>
                {% endif %}
                
                <!-- Classification indicators - ADMIN ONLY -->
                {% if session.get('user_role','')|lower == 'admin' %}
                <h6 class="font-weight-bold mt-3 mb-2">Classification Colors</h6>
                <div class="d-flex align-items-center mb-2">
                  <div style="width: 20px; height: 20px;" class="mr-2 rounded classification-billable"></div>
                  <span>Billable</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <div style="width: 20px; height: 20px;" class="mr-2 rounded classification-non-billable"></div>
                  <span>Non-Billable</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <div style="width: 20px; height: 20px;" class="mr-2 rounded classification-contract-project"></div>
                  <span>Contract/Project</span>
                </div>
                {% endif %}
              </div>
            </div>
            
            <!-- Entry System Progress -->
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="font-weight-bold mb-3">System Entry Progress</h6>
                
                <!-- JL Progress -->
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span>Job Listing:</span>
                    <span id="jl-progress-text">0/0 (0%)</span>
                  </div>
                  <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-info" id="jl-progress-bar" role="progressbar" 
                         style="width: 0%" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100"></div>
                  </div>
                </div>
                
                <!-- JT Progress -->
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span>Job Totals:</span>
                    <span id="jt-progress-text">0/0 (0%)</span>
                  </div>
                  <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-info" id="jt-progress-bar" role="progressbar" 
                         style="width: 0%" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100"></div>
                  </div>
                </div>
                
                <!-- Both Systems -->
                <div>
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span>Both Systems:</span>
                    <span id="both-progress-text">0/0 (0%)</span>
                  </div>
                  <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" id="both-progress-bar" role="progressbar" 
                         style="width: 0%" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden data for charts and JavaScript -->
  <div id="timesheet-data" style="display:none;" 
       data-total-entries="{{ time_entries|length }}"
       data-total-hours="{{ total_hours|round(1) }}">
    
    <!-- Entry data -->
    <div id="entry-data">
      {% for entry in time_entries %}
      <!-- Only include non-adjustment entries or adjustment entries for admins in data -->
      {% set is_adjustment = entry.engineer == 'timeadj' %}
      {% set is_admin = session.get('user_id') and (User.query.get(session.get('user_id')).role.lower() == 'admin' or User.query.get(session.get('user_id')).username.lower() == 'admin') %}
      {% if not is_adjustment or is_admin %}
      <div class="entry-item"
          data-id="{{ entry.id }}"
          data-date="{{ entry.work_date.strftime('%Y-%m-%d') }}"
          data-hours="{{ entry.hours_worked }}"
          data-wo-id="{{ entry.work_order_id }}"
          data-wo-class="{{ entry.work_order.classification|default('Billable', true) }}"
          data-jl="{{ 1 if entry.entered_on_jl else 0 }}"
          data-jt="{{ 1 if entry.entered_on_jt else 0 }}"
          data-is-adjustment="{{ 1 if is_adjustment else 0 }}">
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- Modal for viewing more entries -->
  <div id="entriesModal" class="entries-modal">
    <div class="entries-modal-content">
      <div class="entries-modal-header">
        <h5 id="modalTitle">Time Entries for <span id="modalDate"></span></h5>
        <span class="entries-modal-close">&times;</span>
      </div>
      <div id="modalEntries">
        <!-- Entries will be loaded here dynamically -->
      </div>
    </div>
  </div>
  
  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Main JavaScript -->
  <script>
    // Request Manager for preventing duplicate AJAX calls
    var RequestManager = {
        pendingRequests: {},
        debounceTimers: {},
        
        // Debounced request with deduplication
        makeRequest: function(key, requestFn, delay) {
            delay = delay || 300; // Default 300ms delay
            
            // Clear any existing timer for this key
            if (this.debounceTimers[key]) {
                clearTimeout(this.debounceTimers[key]);
            }
            
            // Cancel any pending request for this key
            if (this.pendingRequests[key]) {
                this.pendingRequests[key].abort();
                delete this.pendingRequests[key];
            }
            
            // Set up new debounced request
            this.debounceTimers[key] = setTimeout(() => {
                // Execute the request and store the jqXHR object
                this.pendingRequests[key] = requestFn();
                
                // Clean up when request completes
                if (this.pendingRequests[key]) {
                    this.pendingRequests[key].always(() => {
                        delete this.pendingRequests[key];
                    });
                }
                
                delete this.debounceTimers[key];
            }, delay);
        }
    };

    $(document).ready(function() {
      // View toggle functionality with proper calendar element hiding
      $('#list-view-btn').click(function() {
        $('#list-view').show();
        $('#calendar-view').hide().removeClass('active');
        $('#list-view-btn').addClass('active');
        $('#calendar-view-btn').removeClass('active');
        $('body').removeClass('calendar-active');
        localStorage.setItem('timesheet-view-preference', 'list');
      });
      
      $('#calendar-view-btn').click(function() {
        $('#list-view').hide();
        $('#calendar-view').show().addClass('active');
        $('#calendar-view-btn').addClass('active');
        $('#list-view-btn').removeClass('active');
        $('body').addClass('calendar-active');
        localStorage.setItem('timesheet-view-preference', 'calendar');
      });
      
      // Load saved view preference
      var viewPreference = localStorage.getItem('timesheet-view-preference');
      if (viewPreference === 'calendar') {
        $('#calendar-view-btn').click();
      }
      
      // Initialize progress bars on page load
      updateSystemProgress();

      // Unbind any existing handlers first to prevent duplicates
      $('.entry-check').off('change');

      // Handle checkbox updates with protection logic - Weekly Timesheet Version
      $('.entry-check').on('change', function(e) {
          e.stopPropagation(); // Prevent event bubbling
          
          var entryId = $(this).data('entry-id');
          var isJL = $(this).hasClass('jl-check');
          var isChecked = $(this).is(':checked');
          var checkbox = $(this);
          
          // Create a unique key for this request
          var requestKey = `checkbox_${entryId}_${isJL ? 'jl' : 'jt'}`;
          
          // Get the checkboxes for this entry
          var jlChecked = $('#entry-' + entryId + ' .jl-check').is(':checked');
          var jtChecked = $('#entry-' + entryId + ' .jt-check').is(':checked');
          
          // Add or remove the completed class to the row
          if (jlChecked && jtChecked) {
              $('#entry-' + entryId).addClass('entry-completed');
          } else {
              $('#entry-' + entryId).removeClass('entry-completed');
          }
          
          // Check if entry is now locked
          var isLocked = jlChecked || jtChecked;
          var row = $('#entry-' + entryId);
          
          // Update UI immediately for better user experience
          if (isLocked) {
              // Add warning styling and lock icon if not already present
              row.addClass('table-warning');
              if (row.find('.fa-lock').length === 0) {
                  row.find('td:first-child').append('<i class="fas fa-lock text-warning ml-1" title="Entry locked - entered in accounting system"></i>');
              }
              
              // Replace action buttons with disabled ones
              var actionCell = row.find('td:last-child');
              actionCell.html(`
                  <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-secondary" disabled title="Cannot reassign - entry locked in accounting system">
                          <i class="fas fa-exchange-alt"></i>
                      </button>
                      <button class="btn btn-outline-secondary" disabled title="Cannot delete - entry locked in accounting system">
                          <i class="fas fa-trash-alt"></i>
                      </button>
                  </div>
              `);
          } else {
              // Remove warning styling and lock icon
              row.removeClass('table-warning');
              row.find('.fa-lock').remove();
              
              // Restore original action buttons
              var actionCell = row.find('.time-inline-actions');
              actionCell.html(`
                  <div class="btn-group btn-group-sm">
                      <a href="/time_entry/${entryId}/reassign" class="btn btn-outline-info" title="Reassign Entry">
                          <i class="fas fa-exchange-alt"></i>
                      </a>
                      <form action="/time_entry/${entryId}/delete" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this time entry?');">
                          <button type="submit" class="btn btn-outline-danger" title="Delete Entry">
                              <i class="fas fa-trash-alt"></i>
                          </button>
                      </form>
                  </div>
              `);
          }
          
          // Update the entry data
          $('.entry-item[data-id="' + entryId + '"]').attr('data-jl', jlChecked ? 1 : 0);
          $('.entry-item[data-id="' + entryId + '"]').attr('data-jt', jtChecked ? 1 : 0);
          
          // Prepare the data for the update
          var data = {
              entered_on_jl: jlChecked,
              entered_on_jt: jtChecked
          };
          
          // Use RequestManager to handle the AJAX request with debouncing
          RequestManager.makeRequest(requestKey, function() {
              return $.ajax({
                  url: '/time_entry/' + entryId + '/update_checkboxes',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response.success) {
                          console.log("Updated checkboxes for entry " + entryId);
                          // Update the system entry progress bars
                          updateSystemProgress();
                          // Show success notification
                          if (typeof showToast === 'function') {
                              showToast((isJL ? 'JL' : 'JT') + ' status updated successfully!');
                          }
                      } else {
                          alert("Error updating entry " + entryId + ": " + (response.message || 'Unknown error'));
                          // Revert the checkbox state
                          checkbox.prop('checked', !isChecked);
                          // Revert UI changes
                          revertUIChanges(row, isChecked, jlChecked, jtChecked);
                      }
                  },
                  error: function(xhr, status, error) {
                      // Only handle error if request wasn't aborted
                      if (status !== 'abort') {
                          console.error('AJAX Error:', {
                              status: xhr.status,
                              statusText: xhr.statusText,
                              responseText: xhr.responseText,
                              error: error
                          });
                          
                          let errorMessage = "Error updating entry " + entryId + ": ";
                          if (xhr.responseJSON && xhr.responseJSON.message) {
                              errorMessage += xhr.responseJSON.message;
                          } else if (xhr.responseText) {
                              errorMessage += xhr.responseText;
                          } else {
                              errorMessage += error;
                          }
                          
                          alert(errorMessage);
                          
                          // Revert the checkbox state
                          checkbox.prop('checked', !isChecked);
                          // Revert UI changes
                          revertUIChanges(row, isChecked, jlChecked, jtChecked);
                      }
                  }
              });
          }, 300); // 300ms debounce delay
      });

      // Helper function to revert UI changes
      function revertUIChanges(row, wasChecking, jlChecked, jtChecked) {
          if (wasChecking) {
              // Was trying to check, revert to unchecked state
              if (!jlChecked && !jtChecked) {
                  row.removeClass('table-warning entry-completed');
                  row.find('.fa-lock').remove();
              }
          } else {
              // Was trying to uncheck, revert to checked state
              row.addClass('table-warning');
              if (jlChecked && jtChecked) {
                  row.addClass('entry-completed');
              }
          }
      }
      
      // Function to update the system progress bars
      function updateSystemProgress() {
        // Count total entries (excluding time adjustments for non-admins)
        var totalEntries = $('.entry-item[data-is-adjustment="0"]').length;
        var isAdmin = document.getElementById('user-data').dataset.isAdmin === 'true';
        
        if (isAdmin) {
          totalEntries = $('.entry-item').length; // Include all entries for admins
        }
        
        if (totalEntries === 0) return;
        
        // Count entries in each system
        var jlCount = 0;
        var jtCount = 0;
        var bothCount = 0;
        
        // Process each entry
        $('.entry-item').each(function() {
          var isAdjustment = parseInt($(this).attr('data-is-adjustment')) === 1;
          
          // Skip adjustments for non-admins in progress calculation
          if (isAdjustment && !isAdmin) {
            return;
          }
          
          var jl = parseInt($(this).attr('data-jl'));
          var jt = parseInt($(this).attr('data-jt'));
          
          if (jl === 1) jlCount++;
          if (jt === 1) jtCount++;
          if (jl === 1 && jt === 1) bothCount++;
        });
        
        // Calculate percentages
        var jlPercentage = Math.round(jlCount / totalEntries * 100);
        var jtPercentage = Math.round(jtCount / totalEntries * 100);
        var bothPercentage = Math.round(bothCount / totalEntries * 100);
        
        // Update the progress bars
        $('#jl-progress-bar').css('width', jlPercentage + '%');
        $('#jl-progress-bar').attr('aria-valuenow', jlPercentage);
        $('#jl-progress-text').text(jlCount + '/' + totalEntries + ' (' + jlPercentage + '%)');
        
        $('#jt-progress-bar').css('width', jtPercentage + '%');
        $('#jt-progress-bar').attr('aria-valuenow', jtPercentage);
        $('#jt-progress-text').text(jtCount + '/' + totalEntries + ' (' + jtPercentage + '%)');
        
        $('#both-progress-bar').css('width', bothPercentage + '%');
        $('#both-progress-bar').attr('aria-valuenow', bothPercentage);
        $('#both-progress-text').text(bothCount + '/' + totalEntries + ' (' + bothPercentage + '%)');
        
        // Update the completion percentage in the summary
        $('#completion-percentage').text(bothPercentage + '%');
      }
      
      // Toast notification function
      function showToast(message) {
        const toast = $('#toastNotification');
        $('#toastText').text(message);
        toast.addClass('show');
        
        // Hide after 3 seconds
        setTimeout(function() {
          toast.removeClass('show');
        }, 3000);
      }
      
      // Make showToast available globally
      window.showToast = showToast;
      
      // Print timesheet functionality
      $('#print-timesheet-btn').click(function() {
        window.print();
      });
      
      // Initialize Charts with proper container management
      initializeCharts();
      
      // Re-initialize charts on window resize to prevent displacement
      $(window).resize(function() {
        setTimeout(initializeCharts, 100);
      });
    });
    
    // Enhanced chart initialization function with container fixes
    function initializeCharts() {
      // Safe chart destruction - check if chart exists AND has destroy method
      if (window.hoursByDayChart && typeof window.hoursByDayChart.destroy === 'function') {
        window.hoursByDayChart.destroy();
        window.hoursByDayChart = null;
      }
      if (window.hoursByTypeChart && typeof window.hoursByTypeChart.destroy === 'function') {
        window.hoursByTypeChart.destroy();
        window.hoursByTypeChart = null;
      }

      // Get data from hidden elements
      const dayData = [0, 0, 0, 0, 0, 0, 0]; // Sun to Sat
      const classificationData = {};
      
      // Process entry data
      $('.entry-item').each(function() {
        const hours = parseFloat($(this).data('hours')) || 0;
        const dateString = $(this).data('date'); // "YYYY-MM-DD"
        const classification = $(this).data('wo-class') || 'Billable';
        
        // Parse date correctly to avoid timezone issues
        const [year, month, day] = dateString.split('-').map(Number);
        const date = new Date(year, month - 1, day, 12, 0, 0); // Month is 0-indexed in JS, use noon time
        
        // Add hours to day data (0 = Sunday, 6 = Saturday)
        const dayOfWeek = date.getDay();
        dayData[dayOfWeek] += hours;
        
        // Add hours to classification data
        if (!classificationData[classification]) {
          classificationData[classification] = 0;
        }
        classificationData[classification] += hours;
      });
      
      // Round day data values
      const roundedDayData = dayData.map(val => Math.round(val * 10) / 10);
      
      // Hours by Day Chart with fixed positioning
      const hoursByDayCtx = document.getElementById('hoursByDayChart');
      if (hoursByDayCtx) {
        // Ensure the chart container has proper dimensions
        const container = hoursByDayCtx.closest('.chart-container');
        if (container) {
          container.style.width = '100%';
          container.style.height = '200px';
          container.style.position = 'relative';
          container.style.overflow = 'hidden';
        }
        
        // Set canvas dimensions
        hoursByDayCtx.style.width = '100%';
        hoursByDayCtx.style.height = '200px';
        
        window.hoursByDayChart = new Chart(hoursByDayCtx, {
          type: 'bar',
          data: {
            labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            datasets: [{
              label: 'Hours by Day',
              data: roundedDayData,
              backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)',
                'rgba(255, 159, 64, 0.5)',
                'rgba(231, 233, 237, 0.5)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(231, 233, 237, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Hours by Day of Week'
            },
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: true
                }
              }]
            }
          }
        });
      }
      
      // Hours by Classification Chart - Only for admin with fixed positioning
      const hoursByTypeCtx = document.getElementById('hoursByTypeChart');
      if (hoursByTypeCtx) {
        // Ensure the chart container has proper dimensions and stays in sidebar
        const container = hoursByTypeCtx.closest('.chart-container');
        if (container) {
          container.style.width = '100%';
          container.style.height = '200px';
          container.style.position = 'relative';
          container.style.overflow = 'hidden';
          // Force container to stay within its parent
          container.style.maxWidth = '100%';
        }
        
        // Set canvas dimensions explicitly
        hoursByTypeCtx.style.width = '100%';
        hoursByTypeCtx.style.height = '200px';
        hoursByTypeCtx.style.maxWidth = '100%';
        
        // Prepare classification data for chart
        const classLabels = [];
        const classValues = [];
        
        // Define color mappings for classifications
        const classColors = {
          'Billable': 'rgba(40, 167, 69, 0.5)',        // Green
          'Non-Billable': 'rgba(255, 193, 7, 0.5)',    // Yellow
          'Contract/Project': 'rgba(0, 123, 255, 0.5)' // Blue
        };
        const classBorders = {
          'Billable': 'rgba(40, 167, 69, 1)',
          'Non-Billable': 'rgba(255, 193, 7, 1)',
          'Contract/Project': 'rgba(0, 123, 255, 1)'
        };
        
        // Prepare arrays for the chart
        const colorArray = [];
        const borderArray = [];
        let totalClassHours = 0;
        
        for (const key in classificationData) {
          classLabels.push(key);
          const value = Math.round(classificationData[key] * 10) / 10;
          classValues.push(value);
          totalClassHours += value;
          
          // Add colors for this classification (with fallback)
          colorArray.push(classColors[key] || 'rgba(150, 150, 150, 0.5)');
          borderArray.push(classBorders[key] || 'rgba(150, 150, 150, 1)');
        }
        
        // Create the chart with fixed positioning
        window.hoursByTypeChart = new Chart(hoursByTypeCtx, {
          type: 'doughnut',
          data: {
            labels: classLabels,
            datasets: [{
              data: classValues,
              backgroundColor: colorArray,
              borderColor: borderArray,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 10
              }
            },
            title: {
              display: true,
              text: 'Hours by Classification'
            },
            tooltips: {
              callbacks: {
                label: function(tooltipItem, data) {
                  const dataset = data.datasets[tooltipItem.datasetIndex];
                  const currentValue = dataset.data[tooltipItem.index];
                  const percentage = parseFloat((currentValue / totalClassHours * 100).toFixed(1));
                  return data.labels[tooltipItem.index] + ': ' + currentValue + ' hrs (' + percentage + '%)';
                }
              }
            }
          }
        });
      }
    }

    // Modal functionality for "View More" entries
    // Close handlers
    $(document).on('click', '.entries-modal-close', function() {
      $('#entriesModal').fadeOut();
    });
    
    $(document).on('click', '#entriesModal', function(e) {
      if (e.target.id === 'entriesModal') {
        $('#entriesModal').fadeOut();
      }
    });

    // Click to open & load
    $(document).on('click', '.view-more-entries', function(e) {
      e.preventDefault();
      const date = $(this).data('date');
      console.log('view-more clicked for', date);

      $('#modalDate').text(date);
      loadEntriesForDate(date);
      $('#entriesModal').fadeIn();
    });

    // Function to load entries for a specific date
    function loadEntriesForDate(date) {
      const $out = $('#modalEntries').empty()
        .append('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
      const entries = [];
      
      // Check if user is admin using the data attribute (properly processed by Jinja2)
      const isAdmin = document.getElementById('user-data').dataset.isAdmin === 'true';

      $('.entry-item').each(function() {
        if ($(this).data('date') === date) {
          const id = $(this).data('id'),
                $row = $('#entry-' + id),
                engineer = $row.find('.engineer-tag').text().trim(),
                work_order = $row.find('a.font-weight-medium').text().trim(),
                time_in = $row.find('td:nth-child(5)').text().trim(),
                time_out = $row.find('td:nth-child(6)').text().trim(),
                hours = $row.find('td.hours-cell').text().trim(),
                description = $row.find('td:nth-child(8)').text().trim() || '',
                classification = $(this).data('wo-class');

          entries.push({ 
            engineer, 
            work_order, 
            time_in, 
            time_out, 
            hours, 
            description,
            classification 
          });
        }
      });

      $out.empty();
      if (!entries.length) {
        return $out.append('<div class="text-center">No entries found for this date.</div>');
      }

      entries.forEach(entry => {
        // Create basic entry HTML (without classification for non-admins)
        let html = `
          <div class="modal-entry-item ${isAdmin ? 'classification-' + entry.classification.toLowerCase().replace('/', '-') : ''}">
            <div class="d-flex justify-content-between align-items-center">
              <strong>${entry.engineer}</strong>`;
              
        // Only add classification badge for admins
        if (isAdmin) {
          html += `<span class="badge badge-${entry.classification.toLowerCase().replace('/', '-')}">${entry.classification}</span>`;
        }
              
        html += `</div>
            <div>${entry.time_in} - ${entry.time_out} (${entry.hours} hrs)</div>
            <div>Order: <strong>${entry.work_order}</strong></div>
            ${entry.description ? `<div class="text-muted small">${entry.description}</div>` : ''}
          </div>`;
          
        $out.append(html);
      });
    }
  </script>
</body>
</html>