<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Admin Dashboard - SATT Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <style>
    /* Navbar */
    
    .navbar-brand img { height: 40px; }
    /* Navbar - Dark Theme */
    .navbar { 
      background-color: #000000 !important;
      border-bottom: 1px solid #333333;
    }

    /* Navbar text colors */
    .navbar-light .navbar-brand,
    .navbar-light .navbar-nav .nav-link {
      color: #ffffff !important;
    }

    .navbar-light .navbar-nav .nav-link:hover {
      color: #66b3ff !important;
    }

    .navbar-light .navbar-toggler {
      border-color: #333333;
    }

    .navbar-light .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    }

    /* Dropdown menus - Dark theme */
    .dropdown-menu { 
      border-radius: .35rem;
      background-color: #1a1a1a;
      border: 1px solid #333333;
    }

    .dropdown-item {
      color: #ffffff;
    }

    .dropdown-item:hover {
      background-color: #333333;
      color: #66b3ff;
    }

    /* Search form styling for dark navbar */
    .navbar .form-control {
      background-color: #2a2a2a;
      border-color: #444444;
      color: #ffffff;
    }

    .navbar .form-control:focus {
      background-color: #333333;
      border-color: #007bff;
      color: #ffffff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .navbar .form-control::placeholder {
      color: #aaaaaa;
    }

    .navbar .btn-outline-primary {
      color: #66b3ff;
      border-color: #66b3ff;
    }

    .navbar .btn-outline-primary:hover {
      background-color: #66b3ff;
      border-color: #66b3ff;
      color: #000000;
    }

    /* Card styling */
    .card {
      border-radius: .35rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 1.5rem;
    }
    .card-header {
      background-color: #f8f9fa;
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    /* Chart canvas containers */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    /* KPI cards */
    .kpi-card {
      text-align: center;
      padding: 1.5rem 1rem;
      transition: all 0.3s ease;
    }
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    .kpi-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .kpi-title {
      font-size: 1rem;
      color: #6c757d;
      margin-bottom: 0;
    }
    
    /* Classification colors */
    .color-contract {
      color: #4e73df;
    }
    .color-billable {
      color: #1cc88a;
    }
    .color-nonbillable {
      color: #f6c23e;
    }
    
    /* Timeline slider */
    .timeline-container {
      padding: 1rem 0;
    }
    
    /* Date range selection */
    .date-range-card {
      background-color: #ffffff;
      border-radius: .35rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .date-range-display {
      display: flex;
      align-items: center;
      font-size: 1.1rem;
      color: #495057;
    }
    
    .date-controls {
      display: flex;
      align-items: center;
    }
    
    /* Summary grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .summary-item {
      background-color: #fff;
      border-radius: 0.35rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    
    .summary-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 0.35rem 0.5rem rgba(0,0,0,0.1);
    }
    
    .summary-label {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }
    
    .summary-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: #495057;
    }
    
    /* Badge styles */
    .badge-custom {
      padding: 0.4rem 0.6rem;
      border-radius: 50rem;
      font-weight: 600;
      font-size: 0.75rem;
    }
    
    .badge-info-light {
      background-color: #e1f5fe;
      color: #0288d1;
    }
    
    .badge-success-light {
      background-color: #e8f5e9;
      color: #388e3c;
    }

    /* Charts with hover effect */
    canvas {
      cursor: pointer;
    }
    
    /* Print styles */
    @media print {
      .no-print {
        display: none;
      }
      .card {
        break-inside: avoid;
      }
    }
    
    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      display: none;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      pointer-events: none;
      z-index: 10;
      max-width: 200px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  {% include 'navbar.html' %}

  <div class="container-fluid mt-3">
    <!-- Page Header and Time Period Navigation -->
    <div class="date-range-card">
      <div>
        <h1 class="h3 mb-0">Admin Dashboard</h1>
        <div class="date-range-display">
          <span class="badge badge-custom badge-info-light mr-2">{{ time_frame|title }}</span>
          <i class="far fa-calendar-alt mr-2"></i> 
          <span>{{ start_date.strftime('%b %d, %Y') }} - {{ end_date.strftime('%b %d, %Y') }}</span>
        </div>
      </div>
      <div class="d-flex">
        <button class="btn btn-outline-primary no-print mr-2" onclick="window.print()">
          <i class="fas fa-print mr-1"></i> Print Dashboard
        </button>
        <button class="btn btn-outline-secondary" type="button" data-toggle="collapse" data-target="#timeFrameCollapse">
          <i class="fas fa-calendar-alt mr-1"></i> Change Time Frame
        </button>
      </div>
    </div>
    
    <!-- Time frame selection form -->
    <div class="collapse mb-4" id="timeFrameCollapse">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Select Time Frame</h5>
        </div>
        <div class="card-body">
          <form method="GET" class="form-inline">
            <div class="form-group mr-3">
              <select name="time_frame" class="form-control" id="time-frame-select">
                <option value="week" {% if time_frame == 'week' %}selected{% endif %}>Last Week</option>
                <option value="month" {% if time_frame == 'month' %}selected{% endif %}>Last Month</option>
                <option value="quarter" {% if time_frame == 'quarter' %}selected{% endif %}>Last Quarter</option>
                <option value="year" {% if time_frame == 'year' %}selected{% endif %}>Last Year</option>
                <option value="custom" {% if time_frame == 'custom' %}selected{% endif %}>Custom Range</option>
              </select>
            </div>
            <div class="form-group mr-3 {% if time_frame != 'custom' %}d-none{% endif %}" id="custom-date-inputs">
              <label class="mr-2">From:</label>
              <input type="date" name="start_date" class="form-control" value="{{ start_date.strftime('%Y-%m-%d') }}">
              <label class="mx-2">To:</label>
              <input type="date" name="end_date" class="form-control" value="{{ end_date.strftime('%Y-%m-%d') }}">
            </div>
            <button type="submit" class="btn btn-primary" id="custom-submit-btn" {% if time_frame != 'custom' %}style="display:none"{% endif %}>Apply</button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- KPI Summary Cards -->
    <div class="row mb-4">
      <div class="col-xl-3 col-md-6">
        <div class="card">
          <div class="card-body kpi-card">
            <div class="kpi-value">{{ total_hours|round(1) }}</div>
            <div class="kpi-title">Total Hours</div>
          </div>
        </div>
      </div>
      {% for classification in chart_data.classifications %}
        <div class="col-xl-3 col-md-6">
          <div class="card">
            <div class="card-body kpi-card">
              <div class="kpi-value {{ 'color-contract' if classification == 'Contract/Project' else 'color-billable' if classification == 'Billable' else 'color-nonbillable' }}">
                {{ chart_data.classificationHours[loop.index0]|round(1) }}
              </div>
              <div class="kpi-title">{{ classification }} Hours</div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    
    <div class="row">
      <div class="col-lg-8">
        <!-- Main Dashboard Charts -->
        <div class="row">
          <!-- Hours by Engineer -->
          <div class="col-xl-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Hours by Engineer</h5>
                <div class="btn-group btn-group-sm no-print">
                  <button class="btn btn-outline-secondary active" id="engineer-hours-btn">Hours</button>
                  <button class="btn btn-outline-secondary" id="engineer-percent-btn">Percentage</button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="engineerChart"></canvas>
                </div>
                <small class="text-muted d-block text-center mt-2">
                  <i class="fas fa-info-circle mr-1"></i> Click on chart elements to view detailed entries
                </small>
              </div>
            </div>
          </div>
          
          <!-- Hours by Classification -->
          <div class="col-xl-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Hours by Classification</h5>
                <div class="btn-group btn-group-sm no-print">
                  <button class="btn btn-outline-secondary active" id="classification-hours-btn">Hours</button>
                  <button class="btn btn-outline-secondary" id="classification-percent-btn">Percentage</button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="classificationChart"></canvas>
                </div>
                <small class="text-muted d-block text-center mt-2">
                  <i class="fas fa-info-circle mr-1"></i> Click on chart elements to view detailed entries
                </small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Stacked Bar Chart: Engineer vs Classification -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0">Engineer Work Classification</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="stackedChart"></canvas>
            </div>
            <small class="text-muted d-block text-center mt-2">
              <i class="fas fa-info-circle mr-1"></i> Click on chart elements to view detailed entries
            </small>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <!-- Dashboard Summary -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Summary</h5>
          </div>
          <div class="card-body">
            <div class="total-hours-display text-center mb-4">
              <div style="font-size: 3rem; font-weight: 700; color: #495057;">{{ total_hours|round(1) }}</div>
              <div class="text-muted">Total Hours</div>
            </div>
            
            <!-- Timeline Chart -->
            <div class="chart-container">
              <canvas id="timelineChart"></canvas>
            </div>
            
            <!-- Detailed Stats -->
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">Active Engineers</div>
                <div class="summary-value">{{ chart_data.engineers|length }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Classifications</div>
                <div class="summary-value">{{ chart_data.classifications|length }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Avg Hours/Day</div>
                <div class="summary-value">{{ (total_hours / ((end_date - start_date).days + 1))|round(1) }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Period</div>
                <div class="summary-value">{{ ((end_date - start_date).days + 1) }} days</div>
              </div>
            </div>
            
            <!-- Classification Legend -->
            <div class="mt-4">
              <h6 class="font-weight-bold mb-2">Classification Colors</h6>
              <div class="d-flex align-items-center mb-2">
                <div style="width: 20px; height: 20px; background-color: rgba(78, 115, 223, 0.8);" class="mr-2 rounded"></div>
                <span>Contract/Project</span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <div style="width: 20px; height: 20px; background-color: rgba(28, 200, 138, 0.8);" class="mr-2 rounded"></div>
                <span>Billable</span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <div style="width: 20px; height: 20px; background-color: rgba(246, 194, 62, 0.8);" class="mr-2 rounded"></div>
                <span>Non-Billable</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Detail Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel">Time Entries</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Header info section -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div id="detailModalInfo">
              <strong>Loading data...</strong>
            </div>
            <div id="detailModalTotal" class="bg-primary text-white py-2 px-3 rounded">
              Total: <span id="detailModalTotalHours">0</span> hours
            </div>
          </div>
          
          <!-- Table for time entries -->
          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Engineer</th>
                  <th>Work Order</th>
                  <th>Description</th>
                  <th>Time In</th>
                  <th>Time Out</th>
                  <th class="text-center">Hours</th>
                  <th>Classification</th>
                </tr>
              </thead>
              <tbody id="detailModalTableBody">
                <tr>
                  <td colspan="8" class="text-center">Loading data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="exportDetailButton">Export to Excel</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  
  <script>
    // Show/hide custom date inputs when time frame selection changes
    document.getElementById('time-frame-select').addEventListener('change', function() {
      const customDateInputs = document.getElementById('custom-date-inputs');
      const customSubmitBtn = document.getElementById('custom-submit-btn');
      
      if (this.value === 'custom') {
        // Show the date inputs and submit button without submitting the form
        customDateInputs.classList.remove('d-none');
        customSubmitBtn.style.display = 'block';
      } else {
        // For non-custom options, hide the date inputs and submit button, then submit the form
        customDateInputs.classList.add('d-none');
        customSubmitBtn.style.display = 'none';
        this.form.submit(); // Only submit for non-custom options
      }
    });
    
    // Chart.js default settings
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
    Chart.defaults.font.size = 12;
    
    // Color palette
    const colors = {
      contract: 'rgba(78, 115, 223, 0.8)',
      billable: 'rgba(28, 200, 138, 0.8)',
      nonbillable: 'rgba(246, 194, 62, 0.8)',
      border: {
        contract: 'rgb(78, 115, 223)',
        billable: 'rgb(28, 200, 138)',
        nonbillable: 'rgb(246, 194, 62)'
      }
    };
    
    // Create a color array for engineers
    function getEngineerColors(count) {
      const colors = [];
      for (let i = 0; i < count; i++) {
        const hue = (i * 137) % 360; // Golden angle to get good distribution
        colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
      }
      return colors;
    }
    
    // Chart data from server
    const chartData = JSON.parse('{{ chart_data|tojson }}');
    const engineerColors = getEngineerColors(chartData.engineers.length);
    
    // Variables to store current date range
    let currentStartDate = '{{ start_date.strftime("%Y-%m-%d") }}';
    let currentEndDate = '{{ end_date.strftime("%Y-%m-%d") }}';
    let detailType = ''; // 'engineer' or 'classification'
    let detailValue = ''; // name of engineer or classification
    
    // Engineer Hours Chart
    const engineerCtx = document.getElementById('engineerChart').getContext('2d');
    const engineerChart = new Chart(engineerCtx, {
      type: 'bar',
      data: {
        labels: chartData.engineers,
        datasets: [{
          label: 'Hours',
          data: chartData.engineerHours,
          backgroundColor: engineerColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Hours'
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed.y.toFixed(1);
                return `${label}: ${value} hours`;
              }
            }
          }
        },
        onClick: function(evt, elements) {
          if (elements.length > 0) {
            const index = elements[0].index;
            const engineer = this.data.labels[index];
            showEngineerDetails(engineer);
          }
        }
      }
    });
    
    // Classification Hours Chart
    const classificationCtx = document.getElementById('classificationChart').getContext('2d');
    const classificationChart = new Chart(classificationCtx, {
      type: 'pie',
      data: {
        labels: chartData.classifications,
        datasets: [{
          label: 'Hours',
          data: chartData.classificationHours,
          backgroundColor: [
            colors.contract,
            colors.billable,
            colors.nonbillable
          ],
          borderColor: [
            colors.border.contract,
            colors.border.billable,
            colors.border.nonbillable
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 15,
              padding: 15
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.formattedValue;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.raw / total) * 100).toFixed(1);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
    
    // Add click event listener separately for more control
    document.getElementById('classificationChart').addEventListener('click', function(evt) {
      const activePoints = classificationChart.getElementsAtEventForMode(
        evt, 'nearest', { intersect: true }, false
      );
      
      if (activePoints.length > 0) {
        const index = activePoints[0].index;
        const classification = chartData.classifications[index];
        console.log('Classification chart clicked:', classification);
        showClassificationDetails(classification);
      }
    });
    
    // Stacked Bar Chart for Engineer vs Classification
    const prepareStackedData = () => {
      const datasets = [];
      
      // Add dataset for each classification type
      chartData.classifications.forEach((classification, index) => {
        const data = [];
        chartData.engineers.forEach(engineer => {
          data.push(chartData.engineerClassificationData[engineer][classification]);
        });
        
        let bgColor;
        let borderColor;
        
        if (classification === 'Contract/Project') {
          bgColor = colors.contract;
          borderColor = colors.border.contract;
        } else if (classification === 'Billable') {
          bgColor = colors.billable;
          borderColor = colors.border.billable;
        } else {
          bgColor = colors.nonbillable;
          borderColor = colors.border.nonbillable;
        }
        
        datasets.push({
          label: classification,
          data: data,
          backgroundColor: bgColor,
          borderColor: borderColor,
          borderWidth: 1
        });
      });
      
      return datasets;
    };
    
    const stackedCtx = document.getElementById('stackedChart').getContext('2d');
    const stackedChart = new Chart(stackedCtx, {
      type: 'bar',
      data: {
        labels: chartData.engineers,
        datasets: prepareStackedData()
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            stacked: true
          },
          y: {
            stacked: true,
            beginAtZero: true,
            title: {
              display: true,
              text: 'Hours'
            }
          }
        },
        onClick: function(evt, elements) {
          if (elements.length > 0) {
            const element = elements[0];
            const datasetIndex = element.datasetIndex;
            const index = element.index;
            const engineer = this.data.labels[index];
            const classification = this.data.datasets[datasetIndex].label;
            
            // Show filtered details for both engineer and classification
            showFilteredDetails(engineer, classification);
          }
        }
      }
    });
    
    // Timeline Chart
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    const timelineChart = new Chart(timelineCtx, {
      type: 'line',
      data: {
        labels: chartData.timelineLabels,
        datasets: [{
          label: 'Hours',
          data: chartData.timelineData,
          backgroundColor: 'rgba(78, 115, 223, 0.2)',
          borderColor: 'rgba(78, 115, 223, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(78, 115, 223, 1)',
          pointRadius: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Hours'
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Hours: ${context.parsed.y.toFixed(1)}`;
              }
            }
          }
        }
      }
    });
    
    // Toggle between hours and percentage for engineer chart
    document.getElementById('engineer-hours-btn').addEventListener('click', function() {
      engineerChart.data.datasets[0].data = chartData.engineerHours;
      engineerChart.options.scales.y.title.text = 'Hours';
      engineerChart.update();
      
      // Toggle active button
      document.getElementById('engineer-percent-btn').classList.remove('active');
      this.classList.add('active');
    });
    
    document.getElementById('engineer-percent-btn').addEventListener('click', function() {
      engineerChart.data.datasets[0].data = chartData.engineerPercentage;
      engineerChart.options.scales.y.title.text = 'Percentage (%)';
      engineerChart.update();
      
      // Toggle active button
      document.getElementById('engineer-hours-btn').classList.remove('active');
      this.classList.add('active');
    });
    
    // Toggle between hours and percentage for classification chart
    document.getElementById('classification-hours-btn').addEventListener('click', function() {
      classificationChart.data.datasets[0].data = chartData.classificationHours;
      classificationChart.update();
      
      // Toggle active button
      document.getElementById('classification-percent-btn').classList.remove('active');
      this.classList.add('active');
    });
    
    document.getElementById('classification-percent-btn').addEventListener('click', function() {
      classificationChart.data.datasets[0].data = chartData.classificationPercentage;
      classificationChart.update();
      
      // Toggle active button
      document.getElementById('classification-hours-btn').classList.remove('active');
      this.classList.add('active');
    });

    // Function to show engineer details
    function showEngineerDetails(engineer) {
      detailType = 'engineer';
      detailValue = engineer;
      
      // Update modal title
      document.getElementById('detailModalLabel').textContent = 'Time Entries for ' + engineer;
      
      // Show loading state
      document.getElementById('detailModalInfo').innerHTML = '<strong>Loading data...</strong>';
      document.getElementById('detailModalTableBody').innerHTML = 
        '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status">' +
        '<span class="sr-only">Loading...</span></div></td></tr>';
      
      // Fetch engineer entries
      fetch(`/admin/dashboard/engineer_entries/${encodeURIComponent(engineer)}?start_date=${currentStartDate}&end_date=${currentEndDate}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          // Update modal info and total hours
          document.getElementById('detailModalInfo').innerHTML = 
            `<strong>Engineer:</strong> ${data.engineer}<br>` +
            `<strong>Period:</strong> ${data.start_date} to ${data.end_date}`;
          document.getElementById('detailModalTotalHours').textContent = data.total_hours.toFixed(2);
          
          // Populate table
          populateDetailTable(data.entries);
          
          // Show the modal
          $('#detailModal').modal('show');
        })
        .catch(error => {
          console.error('Error fetching engineer data:', error);
          document.getElementById('detailModalTableBody').innerHTML = 
            `<tr><td colspan="8" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
        });
    }

    // Function to show classification details
    function showClassificationDetails(classification) {
      detailType = 'classification';
      detailValue = classification;
      
      console.log(`Getting entries for classification: ${classification}`);
      
      // Update modal title
      document.getElementById('detailModalLabel').textContent = classification + ' Time Entries';
      
      // Show loading state
      document.getElementById('detailModalInfo').innerHTML = '<strong>Loading data...</strong>';
      document.getElementById('detailModalTableBody').innerHTML = 
        '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status">' +
        '<span class="sr-only">Loading...</span></div></td></tr>';
      
      // For debugging - show the modal immediately
      $('#detailModal').modal('show');
      
      // Handle Contract/Project classification differently
      if (classification === 'Contract/Project') {
        // Use the all_classification_entries endpoint and filter client-side
        fetch(`/admin/dashboard/all_classification_entries?start_date=${currentStartDate}&end_date=${currentEndDate}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('All classification data received:', data);
            
            // Filter entries for Contract/Project
            const filteredEntries = data.entries.filter(entry => {
              const entryClass = entry.work_order.classification || '';
              return entryClass === 'Contract/Project';
            });
            
            console.log(`Filtered ${filteredEntries.length} Contract/Project entries`);
            
            // Check if we got any entries
            if (!filteredEntries || filteredEntries.length === 0) {
              console.log('No Contract/Project entries found');
              document.getElementById('detailModalTableBody').innerHTML = 
                `<tr><td colspan="8" class="text-center">No entries found for Contract/Project in the selected time period.</td></tr>`;
              document.getElementById('detailModalInfo').innerHTML = 
                `<strong>Classification:</strong> Contract/Project<br>` +
                `<strong>Period:</strong> ${data.start_date} to ${data.end_date}<br>` +
                `<span class="text-warning">No entries found</span>`;
              document.getElementById('detailModalTotalHours').textContent = '0.00';
              return;
            }
            
            // Calculate total hours for Contract/Project entries
            const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.hours_worked, 0);
            
            // Update modal info and total hours
            document.getElementById('detailModalInfo').innerHTML = 
              `<strong>Classification:</strong> Contract/Project<br>` +
              `<strong>Period:</strong> ${data.start_date} to ${data.end_date}`;
            document.getElementById('detailModalTotalHours').textContent = totalHours.toFixed(2);
            
            // Populate table
            populateDetailTable(filteredEntries);
          })
          .catch(error => {
            console.error('Error fetching all classification data:', error);
            document.getElementById('detailModalTableBody').innerHTML = 
              `<tr><td colspan="8" class="text-center text-danger">
                Error loading data: ${error.message}
                <br><br>
                <small>Tried using all_classification_entries as a workaround.</small>
                <br>
                <small>To fix this issue, please add the recommended backend route.</small>
              </td></tr>`;
          });
        return;
      }
      
      // For other classifications, use the normal endpoint
      const classParam = encodeURIComponent(classification);
      
      // Fetch classification entries - use the properly encoded parameter
      fetch(`/admin/dashboard/classification_entries/${classParam}?start_date=${currentStartDate}&end_date=${currentEndDate}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Classification data received:', data);
          
          // Check if we got any entries
          if (!data.entries || data.entries.length === 0) {
            console.log('No entries found for this classification');
            document.getElementById('detailModalTableBody').innerHTML = 
              `<tr><td colspan="8" class="text-center">No entries found for ${classification} in the selected time period.</td></tr>`;
            document.getElementById('detailModalInfo').innerHTML = 
              `<strong>Classification:</strong> ${classification}<br>` +
              `<strong>Period:</strong> ${data.start_date} to ${data.end_date}<br>` +
              `<span class="text-warning">No entries found</span>`;
            document.getElementById('detailModalTotalHours').textContent = '0.00';
            return;
          }
          
          // Update modal info and total hours
          document.getElementById('detailModalInfo').innerHTML = 
            `<strong>Classification:</strong> ${data.classification}<br>` +
            `<strong>Period:</strong> ${data.start_date} to ${data.end_date}`;
          document.getElementById('detailModalTotalHours').textContent = data.total_hours.toFixed(2);
          
          // Populate table
          populateDetailTable(data.entries);
        })
        .catch(error => {
          console.error('Error fetching classification data:', error);
          document.getElementById('detailModalTableBody').innerHTML = 
            `<tr><td colspan="8" class="text-center text-danger">
              Error loading data: ${error.message}
              <br><br>
              <small>This might be due to a URL encoding issue with "${classification}" classification.</small>
            </td></tr>`;
        });
    }
    
    // Function to show filtered details for both engineer and classification
    function showFilteredDetails(engineer, classification) {
      detailType = 'filtered';
      detailValue = `${engineer}-${classification}`;
      
      console.log(`Filtering entries for ${engineer} with classification ${classification}`);
      
      // Update modal title
      document.getElementById('detailModalLabel').textContent = `${classification} Time Entries for ${engineer}`;
      
      // Show loading state
      document.getElementById('detailModalInfo').innerHTML = '<strong>Loading data...</strong>';
      document.getElementById('detailModalTableBody').innerHTML = 
        '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status">' +
        '<span class="sr-only">Loading...</span></div></td></tr>';
      
      // Show the modal immediately
      $('#detailModal').modal('show');
      
      // Fetch engineer entries first, then filter by classification
      fetch(`/admin/dashboard/engineer_entries/${encodeURIComponent(engineer)}?start_date=${currentStartDate}&end_date=${currentEndDate}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Engineer data received:', data);
          
          // Filter entries by classification - handle case insensitive comparison for more reliable matching
          const filteredEntries = data.entries.filter(entry => {
            const entryClass = entry.work_order.classification || '';
            return entryClass.toLowerCase() === classification.toLowerCase();
          });
          
          console.log(`Filtered entries: ${filteredEntries.length} out of ${data.entries.length}`);
          
          // Check if we found any entries
          if (filteredEntries.length === 0) {
            document.getElementById('detailModalTableBody').innerHTML = 
              `<tr><td colspan="8" class="text-center">No entries found for ${engineer} with classification "${classification}" in the selected time period.</td></tr>`;
            document.getElementById('detailModalInfo').innerHTML = 
              `<strong>Engineer:</strong> ${engineer}<br>` +
              `<strong>Classification:</strong> ${classification}<br>` +
              `<strong>Period:</strong> ${data.start_date} to ${data.end_date}<br>` +
              `<span class="text-warning">No matching entries found</span>`;
            document.getElementById('detailModalTotalHours').textContent = '0.00';
            return;
          }
          
          // Calculate total hours for filtered entries
          const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.hours_worked, 0);
          
          // Update modal info and total hours
          document.getElementById('detailModalInfo').innerHTML = 
            `<strong>Engineer:</strong> ${engineer}<br>` +
            `<strong>Classification:</strong> ${classification}<br>` +
            `<strong>Period:</strong> ${data.start_date} to ${data.end_date}`;
          document.getElementById('detailModalTotalHours').textContent = totalHours.toFixed(2);
          
          // Populate table
          populateDetailTable(filteredEntries);
        })
        .catch(error => {
          console.error('Error fetching filtered data:', error);
          document.getElementById('detailModalTableBody').innerHTML = 
            `<tr><td colspan="8" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
        });
    }

    // Function to populate the detail table
    function populateDetailTable(entries) {
      const tableBody = document.getElementById('detailModalTableBody');
      
      if (entries.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No entries found.</td></tr>';
        return;
      }
      
      let tableHtml = '';
      
      entries.forEach(entry => {
        // Add fallback for missing values
        const classification = entry.work_order.classification || 'Billable';
        const engineer = entry.engineer || 'Not Specified';
        const classColor = 
          classification === 'Contract/Project' ? 'text-primary' :
          classification === 'Billable' ? 'text-success' : 'text-warning';
        
        tableHtml += `
          <tr>
            <td>${entry.work_date}</td>
            <td>${engineer}</td>
            <td>
              <a href="/workorder/${entry.work_order.id}" target="_blank">
                ${entry.work_order.satt_job_number} - ${entry.work_order.customer_work_order_number || 'N/A'}
              </a>
            </td>
            <td>${entry.description || ''}</td>
            <td>${entry.time_in}</td>
            <td>${entry.time_out}</td>
            <td class="text-center font-weight-bold">${entry.hours_worked.toFixed(2)}</td>
            <td class="${classColor}">${classification}</td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = tableHtml;
    }

    // Handle export button click
    document.getElementById('exportDetailButton').addEventListener('click', function() {
      // Build a table for export
      const data = [];
      const rows = document.querySelectorAll('#detailModalTableBody tr');
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 8) {
          data.push({
            'Date': cells[0].textContent,
            'Engineer': cells[1].textContent,
            'Work Order': cells[2].textContent.trim(),
            'Description': cells[3].textContent,
            'Time In': cells[4].textContent,
            'Time Out': cells[5].textContent,
            'Hours': cells[6].textContent,
            'Classification': cells[7].textContent
          });
        }
      });
      
      if (data.length === 0) {
        alert('No data to export.');
        return;
      }
      
      // Convert data to CSV
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add headers
      const headers = Object.keys(data[0]);
      csvContent += headers.join(',') + '\r\n';
      
      // Add rows
      data.forEach(function(item) {
        const row = headers.map(header => {
          // Escape quotes and commas in cell values
          const cell = item[header].toString();
          return `"${cell.replace(/"/g, '""')}"`;
        });
        csvContent += row.join(',') + '\r\n';
      });
      
      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `${detailType}-${detailValue}-entries.csv`);
      document.body.appendChild(link);
      
      // Trigger download
      link.click();
      document.body.removeChild(link);
    });

    // Update current date range when form is submitted
    document.querySelector('form').addEventListener('submit', function() {
      const timeFrame = document.querySelector('select[name="time_frame"]').value;
      
      if (timeFrame === 'custom') {
        currentStartDate = document.querySelector('input[name="start_date"]').value;
        currentEndDate = document.querySelector('input[name="end_date"]').value;
      }
    });
    
    // Add cursor styles for interactive charts
    document.querySelectorAll('#engineerChart, #classificationChart, #stackedChart').forEach(canvas => {
      canvas.style.cursor = 'pointer';
    });
    
    // Add directly clickable legend items
    document.addEventListener('DOMContentLoaded', function() {
      // Add legend click handlers for each classification
      const classDiv = document.createElement('div');
      classDiv.className = 'mt-4 text-center';
      classDiv.innerHTML = '<p class="mb-2">Click to view entries:</p>';
      
      const classButtons = document.createElement('div');
      classButtons.className = 'd-flex justify-content-center flex-wrap';
      
      // Create a button for each classification
      chartData.classifications.forEach((classification, index) => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm m-1';
        
        // Set color based on classification
        if (classification === 'Contract/Project') {
          btn.className += ' btn-outline-primary';
        } else if (classification === 'Billable') {
          btn.className += ' btn-outline-success';
        } else {
          btn.className += ' btn-outline-warning';
        }
        
        btn.textContent = classification;
        btn.addEventListener('click', function() {
          showClassificationDetails(classification);
        });
        
        classButtons.appendChild(btn);
      });
      
      classDiv.appendChild(classButtons);
      
      // Add to page after the classification chart
      const classificationCard = document.getElementById('classificationChart').closest('.card');
      classificationCard.querySelector('.card-body').appendChild(classDiv);
    });
  </script>
</body>
</html>