
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Detail - Work Order {{ work_order.satt_job_number }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .cost-summary {
            background: linear-gradient(135deg, #000000 0%, #000000 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .engineer-card {    
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
        }
        .daily-entry {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }
        .cost-highlight {
            background-color: #e8f5e8;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-tools"></i> SATT Work Orders
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="{{ url_for('accounting') }}">
                    <i class="fas fa-arrow-left"></i> Back to Accounting
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Work Order Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-calculator"></i> 
                        Accounting Detail: {{ work_order.satt_job_number }}
                    </h2>
                    <div>
                        <a href="{{ url_for('work_order_detail', work_order_id=work_order.id) }}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Edit Work Order
                        </a>
                        <a href="{{ url_for('accounting') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Accounting
                        </a>
                    </div>
                </div>

                <!-- Work Order Info Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Work Order Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Customer WO#:</strong> {{ work_order.customer_work_order_number or 'N/A' }}</p>
                                <p><strong>SATT Job#:</strong> {{ work_order.satt_job_number }}</p>
                                <p><strong>Description:</strong> {{ work_order.description }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Status:</strong> 
                                    {% if work_order.status == 'Open' %}
                                        <span class="badge bg-primary">{{ work_order.status }}</span>
                                    {% elif work_order.status == 'Complete' %}
                                        <span class="badge bg-success">{{ work_order.status }}</span>
                                    {% elif work_order.status == 'Closed' %}
                                        <span class="badge bg-secondary">{{ work_order.status }}</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ work_order.status }}</span>
                                    {% endif %}
                                </p>
                                <p><strong>Owner:</strong> {{ work_order.owner or 'N/A' }}</p>
                                <p><strong>Priority:</strong> {{ work_order.priority or 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Summary -->
                <div class="cost-summary">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h3>{{ "%.1f"|format(total_hours) }}</h3>
                            <p>Total Hours</p>
                        </div>
                        <div class="col-md-4">
                            <h3>${{ "%.2f"|format(total_cost) }}</h3>
                            <p>Total Cost</p>
                        </div>
                        <div class="col-md-4">
                            <h3>${{ "%.2f"|format(total_cost / total_hours if total_hours > 0 else 0) }}</h3>
                            <p>Average Rate</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Engineer Summary -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-users"></i> Engineer Summary</h5>
                            </div>
                                <div class="card-body">
                                    {% for engineer, data in engineer_summary.items() %}
                                    <div class="engineer-card card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="mb-0">{{ engineer }}</h6>
                                                <span class="cost-highlight">${{ "%.2f"|format(data.total_cost) }}</span>
                                            </div>
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <small class="text-muted">Hours</small>
                                                    <div class="fw-bold">{{ "%.1f"|format(data.total_hours) }}</div>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Avg Rate</small>
                                                    <div class="fw-bold">${{ "%.2f"|format(data.total_cost / data.total_hours if data.total_hours > 0 else 0) }}</div>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">% of Total</small>
                                                    <div class="fw-bold">{{ "%.1f"|format((data.total_hours / total_hours * 100) if total_hours > 0 else 0) }}%</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Detailed entries for this engineer -->
                                            <div class="mt-3">
                                                <button class="btn btn-sm btn-outline-primary" type="button" 
                                                        data-bs-toggle="collapse" 
                                                        data-bs-target="#entries-{{ loop.index }}" 
                                                        aria-expanded="false">
                                                    <i class="fas fa-eye"></i> View Entries ({{ data.entries|length }})
                                                </button>
                                                <div class="collapse mt-2" id="entries-{{ loop.index }}">
                                                    {% for entry in data.entries %}
                                                    <div class="daily-entry">
                                                        <div class="row align-items-center">
                                                            <div class="col-2">
                                                                <small class="text-muted">{{ entry.date.strftime('%m/%d/%Y') }}</small>
                                                            </div>
                                                            <div class="col-2">
                                                                <small>{{ entry.time_in.strftime('%H:%M') }} - {{ entry.time_out.strftime('%H:%M') }}</small>
                                                            </div>
                                                            <div class="col-2 text-center">
                                                                <strong>{{ "%.1f"|format(entry.hours) }}h</strong>
                                                            </div>
                                                            <!-- Role and Rate Display -->
                                                            <div class="col-3 text-center">
                                                                <div>
                                                                    {% if entry.role %}
                                                                        <span class="badge badge-info">{{ entry.role }}</span>
                                                                    {% else %}
                                                                        <span class="badge badge-secondary">No Role</span>
                                                                    {% endif %}
                                                                </div>
                                                                <small class="text-muted">${{ "%.2f"|format(entry.rate) }}/hr</small>
                                                            </div>
                                                            <div class="col-2 text-center">
                                                                <span class="cost-highlight">${{ "%.2f"|format(entry.cost) }}</span>
                                                            </div>
                                                            <div class="col-1">
                                                                <button class="btn btn-sm btn-outline-info" 
                                                                        data-bs-toggle="tooltip" 
                                                                        title="{{ entry.description or 'No description' }}">
                                                                    <i class="fas fa-info"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        {% if entry.description %}
                                                        <div class="row mt-1">
                                                            <div class="col-12">
                                                                <small class="text-muted">{{ entry.description }}</small>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <p class="text-muted text-center">No time entries found for this work order.</p>
                                    {% endfor %}
                                </div>
                        </div>
                    </div>

                    <!-- Daily Breakdown -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-calendar-alt"></i> Daily Breakdown</h5>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                {% for day in daily_breakdown %}
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">{{ day.date.strftime('%B %d, %Y') }}</h6>
                                            <div>
                                                <span class="badge bg-info me-2">{{ "%.1f"|format(day.total_hours) }}h</span>
                                                <span class="badge bg-success">${{ "%.2f"|format(day.total_cost) }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body py-2">
                                        {% for engineer, data in day.engineers.items() %}
                                        <div class="row align-items-center mb-1">
                                            <div class="col-6">
                                                <small>{{ engineer }}</small>
                                            </div>
                                            <div class="col-3 text-center">
                                                <small>{{ "%.1f"|format(data.hours) }}h</small>
                                            </div>
                                            <div class="col-3 text-end">
                                                <small class="cost-highlight">${{ "%.2f"|format(data.cost) }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% else %}
                                <p class="text-muted text-center">No daily breakdown available.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Cost Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="costChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-4">
                                <h6>Engineer Percentages</h6>
                                {% for engineer, data in engineer_summary.items() %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>{{ engineer }}</span>
                                    <span class="fw-bold">{{ "%.1f"|format((data.total_cost / total_cost * 100) if total_cost > 0 else 0) }}%</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rate Information -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-dollar-sign"></i> Current Hourly Rates</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for engineer, rate in user_rates.items() %}
                            {% if engineer in engineer_summary %}
                            <div class="col-md-3 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body text-center py-2">
                                        <h6 class="card-title mb-1">{{ engineer }}</h6>
                                        <p class="card-text mb-0">
                                            {% if rate > 0 %}
                                                <span class="h6 text-success">${{ "%.2f"|format(rate) }}/hr</span>
                                            {% else %}
                                                <span class="text-danger">No rate set</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div class="mt-3">
                            <a href="{{ url_for('admin_edit_rate') }}" class="btn btn-warning">
                                <i class="fas fa-edit"></i> Update Rates
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Create pie chart for cost distribution
        const ctx = document.getElementById('costChart').getContext('2d');
        const engineerData = {
            {% for engineer, data in engineer_summary.items() %}
            "{{ engineer }}"; {{ data.total_cost }},
            {% endfor %}
        };

        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
        ];

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(engineerData),
                datasets: [{
                    data: Object.values(engineerData),
                    backgroundColor: colors.slice(0, Object.keys(engineerData).length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>