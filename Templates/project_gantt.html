<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>{{ project.name }} - Enhanced Gantt Chart - SATT Dashboard</title>
  
  <!-- Bootstrap and Font Awesome -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  
  <!-- DHTMLX Gantt CSS -->
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
  
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f8f9fa;
      --border-color: #dee2e6;
      --text-muted: #6c757d;
      --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    /* ==========================================================================
       NAVBAR STYLING
       ========================================================================== */
    .navbar {
      background-color: #ffffff !important;
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
    }

    .navbar-brand {
      padding: 0.25rem 0;
    }

    .navbar-brand img {
      height: 45px !important;
      max-height: 45px !important;
      width: auto !important;
      max-width: 200px !important;
    }

    .navbar-nav .nav-link {
      color: var(--primary-color) !important;
      font-weight: 500;
    }

    .navbar-nav .nav-link:hover {
      color: var(--secondary-color) !important;
    }

    /* ==========================================================================
       GENERAL LAYOUT & TYPOGRAPHY
       ========================================================================== */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
      color: #2c3e50;
    }

    .page-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-md);
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 0;
    }

    /* ==========================================================================
       MODERN CARD DESIGN
       ========================================================================== */
    .modern-card {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      overflow: hidden;
      margin-bottom: 1.5rem;
      transition: box-shadow 0.3s ease;
    }

    .modern-card:hover {
      box-shadow: var(--shadow-md);
    }

    .card-header-modern {
      background: white;
      border-bottom: 2px solid var(--light-bg);
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title-modern {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* ==========================================================================
       COLOR CODING PANEL
       ========================================================================== */
    .color-coding-panel {
      background: white;
      padding: 1.5rem;
    }

    .color-scheme-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .color-scheme-option {
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .color-scheme-option:hover {
      border-color: var(--secondary-color);
      transform: translateY(-2px);
    }

    .color-scheme-option.active {
      border-color: var(--secondary-color);
      background-color: rgba(52, 152, 219, 0.1);
    }

    .color-scheme-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }

    .color-preview {
      display: flex;
      gap: 4px;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    .color-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* ==========================================================================
       ENHANCED CONTROLS
       ========================================================================== */
    .controls-panel {
      background: white;
      padding: 1.5rem;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-label {
      font-weight: 600;
      color: var(--primary-color);
      min-width: 120px;
    }

    .btn-group-modern {
      background: var(--light-bg);
      border-radius: 8px;
      padding: 4px;
    }

    .btn-modern {
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.3s ease;
      background: transparent;
      color: var(--text-muted);
    }

    .btn-modern:hover {
      background: white;
      color: var(--primary-color);
      box-shadow: var(--shadow-sm);
    }

    .btn-modern.active {
      background: var(--secondary-color);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    /* ==========================================================================
       EXPORT CONTROLS
       ========================================================================== */
    .export-controls-panel {
      background: white;
      padding: 1.5rem;
    }

    .export-format-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .export-format-option {
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .export-format-option:hover {
      border-color: var(--secondary-color);
      transform: translateY(-2px);
    }

    .export-format-option.selected {
      border-color: var(--secondary-color);
      background-color: rgba(52, 152, 219, 0.1);
    }

    .export-icon {
      font-size: 2rem;
      color: var(--secondary-color);
      margin-bottom: 0.5rem;
    }

    .export-title {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .export-description {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* ==========================================================================
       GANTT CHART CONTAINER
       ========================================================================== */
    .gantt-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    #gantt-chart {
      height: 600px;
      width: 100%;
      background-color: #ffffff;
    }

    /* ==========================================================================
       LEGEND ENHANCEMENTS
       ========================================================================== */
    .legend-modern {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .legend-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .legend-item-modern {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      background: var(--light-bg);
      transition: all 0.3s ease;
    }

    .legend-item-modern:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    .legend-color-modern {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .legend-text {
      font-weight: 500;
      color: var(--primary-color);
    }

    /* ==========================================================================
       GANTT TASK STYLING
       ========================================================================== */
    
    /* Status-based colors */
    .gantt_task_line.status-not-started { background: #95a5a6; border-color: #7f8c8d; }
    .gantt_task_line.status-in-progress { background: #3498db; border-color: #2980b9; }
    .gantt_task_line.status-completed { background: #27ae60; border-color: #229954; }
    .gantt_task_line.status-delayed { background: #e74c3c; border-color: #c0392b; }

    /* Priority-based colors */
    .gantt_task_line.priority-low { background: #95a5a6; border-color: #7f8c8d; }
    .gantt_task_line.priority-medium { background: #f39c12; border-color: #e67e22; }
    .gantt_task_line.priority-high { background: #e74c3c; border-color: #c0392b; }

    /* Progress-based colors */
    .gantt_task_line.progress-0 { background: #bdc3c7; border-color: #95a5a6; }
    .gantt_task_line.progress-25 { background: #f39c12; border-color: #e67e22; }
    .gantt_task_line.progress-50 { background: #f1c40f; border-color: #f39c12; }
    .gantt_task_line.progress-75 { background: #2ecc71; border-color: #27ae60; }
    .gantt_task_line.progress-100 { background: #27ae60; border-color: #229954; }

    /* Assignment-based colors */
    .gantt_task_line.assigned-chinkle { background: #9b59b6; border-color: #8e44ad; }
    .gantt_task_line.assigned-rhinkle { background: #e67e22; border-color: #d35400; }
    .gantt_task_line.assigned-aseymour { background: #1abc9c; border-color: #16a085; }
    .gantt_task_line.assigned-aaviles { background: #34495e; border-color: #2c3e50; }
    .gantt_task_line.assigned-ayork { background: #e91e63; border-color: #c2185b; }

    /* Duration-based colors */
    .gantt_task_line.duration-short { background: #2ecc71; border-color: #27ae60; }
    .gantt_task_line.duration-medium { background: #f39c12; border-color: #e67e22; }
    .gantt_task_line.duration-long { background: #e74c3c; border-color: #c0392b; }

    /* Task content styling */
    .gantt_task_content {
      color: white !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      font-weight: 500;
      padding: 4px 8px;
    }

    /* ==========================================================================
       EXPORT PROGRESS MODAL
       ========================================================================== */
    .export-progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .export-progress-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      text-align: center;
      max-width: 400px;
    }

    .export-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--light-bg);
      border-top-color: var(--secondary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ==========================================================================
       RESPONSIVE DESIGN
       ========================================================================== */
    @media (max-width: 768px) {
      .page-title {
        font-size: 2rem;
      }
      
      .control-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .control-label {
        min-width: auto;
      }
      
      .color-scheme-selector {
        grid-template-columns: 1fr;
      }
    }

    /* ==========================================================================
       UTILITY CLASSES
       ========================================================================== */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <!-- Include existing navigation -->
  {% include 'navbar.html' %}

  <!-- Export Progress Modal -->
  <div id="exportProgressModal" class="export-progress-modal">
    <div class="export-progress-content">
      <div class="export-spinner"></div>
      <h4>Generating PDF...</h4>
      <p class="text-muted">Please wait while we prepare your document</p>
    </div>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="page-title">{{ project.name }}</h1>
          <p class="page-subtitle">
            <i class="fas fa-chart-gantt mr-2"></i>
            Interactive Project Timeline & Schedule
          </p>
        </div>
        <div class="col-md-4 text-right">
          <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-outline-light btn-lg">
            <i class="fas fa-arrow-left mr-2"></i>Back to Project
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <!-- Color Coding Panel -->
    <div class="modern-card fade-in">
      <div class="card-header-modern">
        <h3 class="card-title-modern">
          <i class="fas fa-palette"></i>
          Color Coding Options
        </h3>
        <small class="text-muted">Choose how to visualize your tasks</small>
      </div>
      <div class="color-coding-panel">
        <div class="color-scheme-selector">
          <div class="color-scheme-option active" data-scheme="status">
            <div class="color-scheme-title">Status-Based</div>
            <div class="color-preview">
              <div class="color-dot" style="background-color: #95a5a6;"></div>
              <div class="color-dot" style="background-color: #3498db;"></div>
              <div class="color-dot" style="background-color: #27ae60;"></div>
              <div class="color-dot" style="background-color: #e74c3c;"></div>
            </div>
            <small class="text-muted">Color by task status</small>
          </div>
          
          <div class="color-scheme-option" data-scheme="priority">
            <div class="color-scheme-title">Priority-Based</div>
            <div class="color-preview">
              <div class="color-dot" style="background-color: #95a5a6;"></div>
              <div class="color-dot" style="background-color: #f39c12;"></div>
              <div class="color-dot" style="background-color: #e74c3c;"></div>
            </div>
            <small class="text-muted">Color by priority level</small>
          </div>
          
          <div class="color-scheme-option" data-scheme="progress">
            <div class="color-scheme-title">Progress-Based</div>
            <div class="color-preview">
              <div class="color-dot" style="background-color: #bdc3c7;"></div>
              <div class="color-dot" style="background-color: #f39c12;"></div>
              <div class="color-dot" style="background-color: #f1c40f;"></div>
              <div class="color-dot" style="background-color: #2ecc71;"></div>
              <div class="color-dot" style="background-color: #27ae60;"></div>
            </div>
            <small class="text-muted">Color by completion %</small>
          </div>
          
          <div class="color-scheme-option" data-scheme="assignee">
            <div class="color-scheme-title">Assignee-Based</div>
            <div class="color-preview">
              <div class="color-dot" style="background-color: #9b59b6;"></div>
              <div class="color-dot" style="background-color: #e67e22;"></div>
              <div class="color-dot" style="background-color: #1abc9c;"></div>
              <div class="color-dot" style="background-color: #34495e;"></div>
            </div>
            <small class="text-muted">Color by assigned person</small>
          </div>
          
          <div class="color-scheme-option" data-scheme="duration">
            <div class="color-scheme-title">Duration-Based</div>
            <div class="color-preview">
              <div class="color-dot" style="background-color: #2ecc71;"></div>
              <div class="color-dot" style="background-color: #f39c12;"></div>
              <div class="color-dot" style="background-color: #e74c3c;"></div>
            </div>
            <small class="text-muted">Color by task duration</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Controls Panel -->
    <div class="modern-card fade-in">
      <div class="card-header-modern">
        <h3 class="card-title-modern">
          <i class="fas fa-cogs"></i>
          View Controls
        </h3>
        <small class="text-muted">Customize your timeline view</small>
      </div>
      <div class="controls-panel">
        <div class="row">
          <div class="col-md-6">
            <div class="control-group">
              <span class="control-label">Time Scale:</span>
              <div class="btn-group-modern">
                <button type="button" class="btn-modern active" id="day">Day</button>
                <button type="button" class="btn-modern" id="week">Week</button>
                <button type="button" class="btn-modern" id="month">Month</button>
              </div>
            </div>
            
            <div class="control-group">
              <span class="control-label">Zoom:</span>
              <div class="btn-group-modern">
                <button type="button" class="btn-modern" id="zoom-out">
                  <i class="fas fa-search-minus"></i>
                </button>
                <button type="button" class="btn-modern" id="fit-all">
                  <i class="fas fa-expand-arrows-alt"></i> Fit All
                </button>
                <button type="button" class="btn-modern" id="zoom-in">
                  <i class="fas fa-search-plus"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="control-group">
              <span class="control-label">Show:</span>
              <div class="btn-group-modern">
                <button type="button" class="btn-modern active" id="show-all">All Tasks</button>
                <button type="button" class="btn-modern" id="show-critical">Critical Path</button>
                <button type="button" class="btn-modern" id="show-incomplete">Incomplete</button>
              </div>
            </div>
            
            <div class="control-group">
              <span class="control-label">Actions:</span>
              <div class="btn-group-modern">
                <button type="button" class="btn-modern" id="refresh-chart">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn-modern" id="export-data">
                  <i class="fas fa-download"></i> Export
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Options Panel -->
    <div class="modern-card fade-in">
      <div class="card-header-modern">
        <h3 class="card-title-modern">
          <i class="fas fa-file-export"></i>
          Export Options
        </h3>
        <small class="text-muted">Export your Gantt chart in various formats</small>
      </div>
      <div class="export-controls-panel">
        <div class="export-format-selector">
          <div class="export-format-option selected" data-format="pdf">
            <div class="export-icon">
              <i class="fas fa-file-pdf"></i>
            </div>
            <div class="export-title">PDF</div>
            <div class="export-description">
              Best for printing
            </div>
          </div>
          
          <div class="export-format-option" data-format="png">
            <div class="export-icon">
              <i class="fas fa-file-image"></i>
            </div>
            <div class="export-title">PNG</div>
            <div class="export-description">
              High-quality image
            </div>
          </div>
          
          <div class="export-format-option" data-format="excel">
            <div class="export-icon">
              <i class="fas fa-file-excel"></i>
            </div>
            <div class="export-title">Excel</div>
            <div class="export-description">
              Editable spreadsheet
            </div>
          </div>
          
          <div class="export-format-option" data-format="ical">
            <div class="export-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="export-title">iCal</div>
            <div class="export-description">
              Calendar format
            </div>
          </div>
        </div>
        
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="control-group">
              <span class="control-label">Paper Size:</span>
              <select class="form-control" id="paper-size" style="width: 200px;">
                <option value="A4">A4</option>
                <option value="A3">A3</option>
                <option value="Letter">Letter</option>
                <option value="Legal">Legal</option>
              </select>
            </div>
          </div>
          
          <div class="col-md-6 text-right">
            <button class="btn btn-primary btn-lg" id="export-btn">
              <i class="fas fa-download mr-2"></i>Export Chart
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Dynamic Legend -->
    <div class="legend-modern" id="chart-legend">
      <h5 class="mb-3">
        <i class="fas fa-info-circle mr-2"></i>
        Legend - <span id="legend-title">Status-Based Coloring</span>
      </h5>
      <div class="legend-grid" id="legend-content">
        <!-- Legend items will be populated by JavaScript -->
      </div>
    </div>

    <!-- Gantt Chart Container -->
    <div class="modern-card gantt-container fade-in">
      <div class="card-header-modern">
        <h3 class="card-title-modern">
          <i class="fas fa-chart-gantt"></i>
          Project Timeline
        </h3>
        <div>
          <span class="badge badge-info">
            <i class="fas fa-tasks mr-1"></i>
            <span id="task-count">0</span> Tasks
          </span>
          <span class="badge badge-secondary ml-2">
            <i class="fas fa-clock mr-1"></i>
            <span id="project-duration">0</span> Days
          </span>
        </div>
      </div>
      
      <!-- Hidden data fields -->
      <input type="hidden" id="project-id" value="{{ project.id }}">
      <input type="hidden" id="has-tasks" value="{{ '1' if project.tasks else '0' }}">
      
      <!-- Gantt chart -->
      <div id="gantt-chart"></div>
      
      <!-- Empty state -->
      <div id="empty-state" class="text-center py-5" style="display: none;">
        <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
        <h3 class="text-muted">No Tasks With Valid Dates</h3>
        <p class="text-muted mb-4">Add tasks with start and end dates to see the Gantt chart.</p>
        <a href="{{ url_for('new_task', project_id=project.id) }}" class="btn btn-success btn-lg">
          <i class="fas fa-plus mr-2"></i>Add Task With Dates
        </a>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
  <script src="https://export.dhtmlx.com/gantt/api.js"></script>
  
<script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("Enhanced Gantt Chart with Export functionality initializing...");
      
      // Get project data
      var projectId = document.getElementById('project-id').value;
      var hasTasks = document.getElementById('has-tasks').value === '1';
      
      // Current settings
      var currentColorScheme = 'status';
      var currentExportFormat = 'pdf';
      var currentScale = 'day';
      var showOnlyIncomplete = false;
      var showOnlyCritical = false;
      var allTasksData = [];
      
      // Legend data for different color schemes
      var legendData = {
        status: [
          { color: '#95a5a6', label: 'Not Started' },
          { color: '#3498db', label: 'In Progress' },
          { color: '#27ae60', label: 'Completed' },
          { color: '#e74c3c', label: 'Delayed' }
        ],
        priority: [
          { color: '#95a5a6', label: 'Low Priority' },
          { color: '#f39c12', label: 'Medium Priority' },
          { color: '#e74c3c', label: 'High Priority' }
        ],
        progress: [
          { color: '#bdc3c7', label: '0% Complete' },
          { color: '#f39c12', label: '1-25% Complete' },
          { color: '#f1c40f', label: '26-75% Complete' },
          { color: '#2ecc71', label: '76-99% Complete' },
          { color: '#27ae60', label: '100% Complete' }
        ],
        assignee: [], // Will be populated dynamically
        duration: [
          { color: '#2ecc71', label: 'Short (1-3 days)' },
          { color: '#f39c12', label: 'Medium (4-10 days)' },
          { color: '#e74c3c', label: 'Long (11+ days)' }
        ]
      };
      
      // Function to generate a color for an assignee
      function getAssigneeColor(assigneeName) {
        // Use a hash function to generate consistent colors for each name
        var hash = 0;
        for (var i = 0; i < assigneeName.length; i++) {
          hash = assigneeName.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        // Generate color from hash
        var hue = hash % 360;
        return `hsl(${hue}, 70%, 50%)`;
      }
      
      // Function to update assignee legend dynamically
      function updateAssigneeLegend() {
        var assignees = new Set();
        
        // Collect all unique assignees from tasks
        allTasksData.forEach(function(task) {
          if (task.assigned_to) {
            assignees.add(task.assigned_to);
          }
        });
        
        // Clear and rebuild assignee legend
        legendData.assignee = [];
        var assigneeColors = {};
        
        assignees.forEach(function(assignee) {
          var color = getAssigneeColor(assignee);
          assigneeColors[assignee] = color;
          legendData.assignee.push({
            color: color,
            label: assignee
          });
        });
        
        // Store colors for use in task styling
        window.assigneeColors = assigneeColors;
      }
      
      // Initialize Gantt configuration
      function initializeGantt() {
        // Enhanced zoom configuration
        gantt.ext.zoom.init({
          levels: [
            {
              name: "day",
              scale_height: 50,
              min_column_width: 50,
              scales: [
                { unit: "month", step: 1, format: "%F %Y" },
                { unit: "day", step: 1, format: "%d" }
              ]
            },
            {
              name: "week", 
              scale_height: 50,
              min_column_width: 70,
              scales: [
                { unit: "month", step: 1, format: "%F %Y" },
                { unit: "week", step: 1, format: "Week %W" }
              ]
            },
            {
              name: "month",
              scale_height: 50,
              min_column_width: 120,
              scales: [
                { unit: "year", step: 1, format: "%Y" },
                { unit: "month", step: 1, format: "%M" }
              ]
            }
          ]
        });
        
        // Set default zoom
        gantt.ext.zoom.setLevel("day");
        
        // Enhanced configuration
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.row_height = 40;
        gantt.config.bar_height = 25;
        gantt.config.grid_width = 300;
        gantt.config.show_progress = true;
        gantt.config.order_branch = true;
        gantt.config.order_branch_free = true;
        gantt.config.smart_rendering = false; // Important for export
        gantt.config.static_background = true; // Important for export
        
        // Enhanced columns
        gantt.config.columns = [
          {
            name: "text",
            label: "Task name",
            width: "*",
            min_width: 150,
            tree: true
          },
          {
            name: "assigned_to",
            label: "Assigned",
            width: 80,
            align: "center",
            template: function(task) {
              return task.assigned_to || "-";
            }
          },
          {
            name: "duration",
            label: "Days",
            width: 50,
            align: "center"
          }
        ];
        
        // Task class template for color coding
        gantt.templates.task_class = function(start, end, task) {
          return getTaskClass(task);
        };
        
        // Enhanced tooltip
        gantt.templates.tooltip_text = function(start, end, task) {
          var startDate = gantt.date.date_to_str("%M %d, %Y")(start);
          var endDate = gantt.date.date_to_str("%M %d, %Y")(end);
          var progress = Math.round((task.progress || 0) * 100);
          
          return `<div class="gantt-tooltip">
            <h4>${task.text}</h4>
            <p><strong>Start:</strong> ${startDate}</p>
            <p><strong>End:</strong> ${endDate}</p>
            <p><strong>Progress:</strong> ${progress}%</p>
            <p><strong>Status:</strong> ${task.status || 'Not Started'}</p>
            ${task.assigned_to ? `<p><strong>Assigned:</strong> ${task.assigned_to}</p>` : ''}
          </div>`;
        };
        
        // Initialize the chart
        gantt.init("gantt-chart");
        
        // Load data
        loadGanttData();
      }
      
      // Get task CSS class based on current color scheme
      function getTaskClass(task) {
        var classes = [];
        
        switch(currentColorScheme) {
          case 'status':
            var status = (task.status || 'not-started').toLowerCase().replace(/\s+/g, '-');
            classes.push('status-' + status);
            break;
            
          case 'priority':
            var priority = (task.priority || 'medium').toLowerCase();
            classes.push('priority-' + priority);
            break;
            
          case 'progress':
            var progress = Math.round((task.progress || 0) * 100);
            if (progress === 0) classes.push('progress-0');
            else if (progress <= 25) classes.push('progress-25');
            else if (progress <= 75) classes.push('progress-50');
            else if (progress < 100) classes.push('progress-75');
            else classes.push('progress-100');
            break;
            
          case 'assignee':
            var assignee = task.assigned_to;
            if (assignee && window.assigneeColors && window.assigneeColors[assignee]) {
              // Create a unique class name from the assignee name
              var classNameSafe = 'assigned-' + assignee.toLowerCase().replace(/[^a-z0-9]/g, '-');
              classes.push(classNameSafe);
              
              // Dynamically inject CSS for this assignee if not already present
              var styleId = 'assignee-style-' + classNameSafe;
              if (!document.getElementById(styleId)) {
                var style = document.createElement('style');
                style.id = styleId;
                style.textContent = `.gantt_task_line.${classNameSafe} { 
                  background: ${window.assigneeColors[assignee]}; 
                  border-color: ${window.assigneeColors[assignee]}; 
                  filter: brightness(1.1);
                }`;
                document.head.appendChild(style);
              }
            }
            break;
            
          case 'duration':
            var duration = task.duration || 1;
            if (duration <= 3) classes.push('duration-short');
            else if (duration <= 10) classes.push('duration-medium');
            else classes.push('duration-long');
            break;
        }
        
        return classes.join(' ');
      }
      
      // Load Gantt data from API
      function loadGanttData() {
        if (!hasTasks) {
          showEmptyState();
          return;
        }
        
        $.getJSON("/api/projects/" + projectId + "/gantt_data")
          .done(function(data) {
            console.log("Gantt data received:", data);
            
            if (!data.data || data.data.length === 0) {
              showEmptyState();
              return;
            }
            
            // Store original data for filtering
            allTasksData = data.data;
            
            // Update assignee colors based on actual data
            updateAssigneeLegend();
            
            // Apply current filters
            var filteredData = applyFilters(data.data);
            
            // Parse data and update UI
            gantt.parse({data: filteredData, links: data.links || []});
            updateProjectStats(filteredData);
            gantt.render();
            
            // Auto-fit to show all tasks
            setTimeout(function() {
              document.getElementById('fit-all').click();
            }, 500);
          })
          .fail(function(jqXHR, textStatus, errorThrown) {
            console.error("Error loading Gantt data:", textStatus, errorThrown);
            showEmptyState();
          });
      }
      
      // Apply current filters to task data
      function applyFilters(tasks) {
        var filtered = tasks.slice(); // Copy array
        
        if (showOnlyIncomplete) {
          filtered = filtered.filter(function(task) {
            return task.status !== 'Completed' && task.status !== 'completed';
          });
        }
        
        if (showOnlyCritical) {
          filtered = filtered.filter(function(task) {
            return task.priority === 'High' || task.priority === 'high' || task.dependencies;
          });
        }
        
        return filtered;
      }
      
      // Refresh chart with current filters
      function refreshChart() {
        var filteredData = applyFilters(allTasksData);
        gantt.clearAll();
        gantt.parse({data: filteredData, links: []});
        updateProjectStats(filteredData);
        gantt.render();
      }
      
      // Show empty state
      function showEmptyState() {
        document.getElementById('gantt-chart').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
      }
      
      // Update project statistics
      function updateProjectStats(tasks) {
        document.getElementById('task-count').textContent = tasks.length;
        
        if (tasks.length > 0) {
          var dates = tasks.map(t => new Date(t.start_date));
          var minDate = new Date(Math.min.apply(null, dates));
          var maxDate = new Date(Math.max.apply(null, dates.map(t => {
            var start = new Date(t.start_date);
            return new Date(start.getTime() + (t.duration * 24 * 60 * 60 * 1000));
          })));
          
          var duration = Math.ceil((maxDate - minDate) / (24 * 60 * 60 * 1000));
          document.getElementById('project-duration').textContent = duration;
        }
      }
      
      // Update legend based on current color scheme
      function updateLegend() {
        var legendContent = document.getElementById('legend-content');
        var legendTitle = document.getElementById('legend-title');
        
        // For assignee scheme, make sure it's updated
        if (currentColorScheme === 'assignee') {
          updateAssigneeLegend();
        }
        
        var currentLegend = legendData[currentColorScheme];
        
        // Update title
        var titles = {
          status: 'Status-Based Coloring',
          priority: 'Priority-Based Coloring', 
          progress: 'Progress-Based Coloring',
          assignee: 'Assignee-Based Coloring',
          duration: 'Duration-Based Coloring'
        };
        legendTitle.textContent = titles[currentColorScheme];
        
        // Update legend items
        legendContent.innerHTML = '';
        currentLegend.forEach(function(item) {
          var legendItem = document.createElement('div');
          legendItem.className = 'legend-item-modern';
          legendItem.innerHTML = `
            <div class="legend-color-modern" style="background-color: ${item.color};"></div>
            <span class="legend-text">${item.label}</span>
          `;
          legendContent.appendChild(legendItem);
        });
      }
      
      // Color scheme selection
      document.querySelectorAll('.color-scheme-option').forEach(function(option) {
        option.addEventListener('click', function() {
          // Update active state
          document.querySelectorAll('.color-scheme-option').forEach(o => o.classList.remove('active'));
          this.classList.add('active');
          
          // Update color scheme
          currentColorScheme = this.dataset.scheme;
          updateLegend();
          gantt.render(); // Re-render with new colors
        });
      });
      
      // Export format selection
      document.querySelectorAll('.export-format-option').forEach(function(option) {
        option.addEventListener('click', function() {
          document.querySelectorAll('.export-format-option').forEach(o => o.classList.remove('selected'));
          this.classList.add('selected');
          currentExportFormat = this.dataset.format;
        });
      });
      
      // Control button handlers
      document.getElementById('zoom-in').addEventListener('click', () => gantt.ext.zoom.zoomIn());
      document.getElementById('zoom-out').addEventListener('click', () => gantt.ext.zoom.zoomOut());
      
      document.getElementById('fit-all').addEventListener('click', function() {
        var tasks = gantt.getTaskByTime();
        if (tasks.length > 0) {
          var dates = tasks.map(t => t.start_date);
          var minDate = new Date(Math.min.apply(null, dates));
          var maxDate = new Date(Math.max.apply(null, tasks.map(t => t.end_date || t.start_date)));
          
          // Add padding
          minDate.setDate(minDate.getDate() - 2);
          maxDate.setDate(maxDate.getDate() + 2);
          
          gantt.config.start_date = minDate;
          gantt.config.end_date = maxDate;
          gantt.render();
        }
      });
      
      // Scale button handlers
      ['day', 'week', 'month'].forEach(function(scale) {
        document.getElementById(scale).addEventListener('click', function() {
          document.querySelectorAll('#day, #week, #month').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentScale = scale;
          gantt.ext.zoom.setLevel(scale);
        });
      });
      
      // Filter button handlers
      document.getElementById('show-all').addEventListener('click', function() {
        document.querySelectorAll('#show-all, #show-critical, #show-incomplete').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        showOnlyIncomplete = false;
        showOnlyCritical = false;
        refreshChart();
      });
      
      document.getElementById('show-critical').addEventListener('click', function() {
        document.querySelectorAll('#show-all, #show-critical, #show-incomplete').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        showOnlyCritical = true;
        showOnlyIncomplete = false;
        refreshChart();
      });
      
      document.getElementById('show-incomplete').addEventListener('click', function() {
        document.querySelectorAll('#show-all, #show-critical, #show-incomplete').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        showOnlyIncomplete = true;
        showOnlyCritical = false;
        refreshChart();
      });
      
      // Refresh button handler
      document.getElementById('refresh-chart').addEventListener('click', function() {
        this.innerHTML = '<span class="loading-spinner"></span> Refreshing...';
        this.disabled = true;
        
        setTimeout(() => {
          loadGanttData();
          this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
          this.disabled = false;
        }, 500);
      });
      
      // Export data button handler (CSV)
      document.getElementById('export-data').addEventListener('click', function() {
        exportGanttDataToCSV();
      });
      
      // Export functionality to CSV
      function exportGanttDataToCSV() {
        try {
          var tasks = gantt.getTaskByTime();
          var csvContent = "data:text/csv;charset=utf-8,";
          
          // CSV Headers
          csvContent += "Task Name,Start Date,End Date,Duration,Status,Priority,Assigned To,Progress\n";
          
          // Add task data
          tasks.forEach(function(task) {
            var startDate = gantt.date.date_to_str("%Y-%m-%d")(task.start_date);
            var endDate = gantt.date.date_to_str("%Y-%m-%d")(task.end_date);
            var progress = Math.round((task.progress || 0) * 100) + '%';
            
            csvContent += `"${task.text}","${startDate}","${endDate}",${task.duration},"${task.status || 'Not Started'}","${task.priority || 'Medium'}","${task.assigned_to || ''}","${progress}"\n`;
          });
          
          // Create download link
          var encodedUri = encodeURI(csvContent);
          var link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", `gantt_chart_${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
        } catch (error) {
          console.error('Export error:', error);
          alert('Error exporting data. Please try again.');
        }
      }
      
      // EXPORT FUNCTIONALITY - USING DHTMLX EXPORT SERVICE
      document.getElementById('export-btn').addEventListener('click', function() {
        exportGantt();
      });
      
      function exportGantt() {
        console.log('Starting export with format:', currentExportFormat);
        
        // Show progress modal
        var progressModal = document.getElementById('exportProgressModal');
        progressModal.style.display = 'flex';
        
        // Get paper size
        var paperSize = document.getElementById('paper-size').value;
        
        // Configure   settings based on format
        var exportConfig = {
          name: document.querySelector('.page-title').textContent.replace(/[^a-z0-9]/gi, '_'),
          locale: 'en',
          skin: 'terrace',
          data: [],
          server: 'https://export.dhtmlx.com/gantt',
          raw: true
        };
        
        // Add format-specific configurations
        switch (currentExportFormat) {
          case 'pdf':
            exportConfig.header = '<h2>' + document.querySelector('.page-title').textContent + '</h2>';
            exportConfig.footer = '<p>Generated on ' + new Date().toLocaleDateString() + '</p>';
            exportConfig.orientation = paperSize === 'A3' ? 'landscape' : 'portrait';
            exportToPDF(exportConfig);
            break;
            
          case 'png':
            exportConfig.header = document.querySelector('.page-title').textContent;
            exportToPNG(exportConfig);
            break;
            
          case 'excel':
            exportToExcel(exportConfig);
            break;
            
          case 'ical':
            exportToICal(exportConfig);
            break;
            
          default:
            console.error('Unknown export format:', currentExportFormat);
            progressModal.style.display = 'none';
            alert('Invalid export format selected');
        }
      }
      
      function exportToPDF(config) {
        try {
          gantt.exportToPDF({
            name: config.name,
            header: config.header,
            footer: config.footer,
            orientation: config.orientation,
            format: config.paperSize || 'A4',
            zoom: 1,
            server: config.server
          });
          
          // Hide progress modal after a delay
          setTimeout(function() {
            document.getElementById('exportProgressModal').style.display = 'none';
          }, 2000);
          
        } catch (error) {
          console.error('PDF export error:', error);
          document.getElementById('exportProgressModal').style.display = 'none';
          alert('Error exporting to PDF. Please try again.');
        }
      }
      
      function exportToPNG(config) {
        try {
          gantt.exportToPNG({
            name: config.name,
            header: config.header,
            server: config.server
          });
          
          // Hide progress modal after a delay
          setTimeout(function() {
            document.getElementById('exportProgressModal').style.display = 'none';
          }, 2000);
          
        } catch (error) {
          console.error('PNG export error:', error);
          document.getElementById('exportProgressModal').style.display = 'none';
          alert('Error exporting to PNG. Please try again.');
        }
      }
      
      function exportToExcel(config) {
        try {
          gantt.exportToExcel({
            name: config.name,
            columns: [
              { id: "text", header: "Task name", width: 200 },
              { id: "start_date", header: "Start date", width: 100, type: "date" },
              { id: "duration", header: "Duration", width: 80, type: "number" },
              { id: "assigned_to", header: "Assigned to", width: 100 },
              { id: "status", header: "Status", width: 100 },
              { id: "progress", header: "Progress", width: 80, type: "number", template: function(task) {
                return Math.round((task.progress || 0) * 100) + "%";
              }}
            ],
            server: config.server,
            visual: false,
            cellColors: true
          });
          
          // Hide progress modal after a delay
          setTimeout(function() {
            document.getElementById('exportProgressModal').style.display = 'none';
          }, 2000);
          
        } catch (error) {
          console.error('Excel export error:', error);
          document.getElementById('exportProgressModal').style.display = 'none';
          alert('Error exporting to Excel. Please try again.');
        }
      }
      
      function exportToICal(config) {
        try {
          gantt.exportToICal({
            name: config.name,
            server: config.server
          });
          
          // Hide progress modal after a delay
          setTimeout(function() {
            document.getElementById('exportProgressModal').style.display = 'none';
          }, 2000);
          
        } catch (error) {
          console.error('iCal export error:', error);
          document.getElementById('exportProgressModal').style.display = 'none';
          alert('Error exporting to iCal. Please try again.');
        }
      }
      
      // Initialize everything
      if (hasTasks) {
        initializeGantt();
      } else {
        showEmptyState();
      }
      
      updateLegend();
      
      console.log("Enhanced Gantt Chart with Export functionality initialized successfully");
    });
  </script>
</body>
</html>